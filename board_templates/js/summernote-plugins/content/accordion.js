/**
 * Board Templates Summernote Accordion ÌîåÎü¨Í∑∏Ïù∏
 * Phase 2: Ï†ëÏùÑ Ïàò ÏûàÎäî ÏΩòÌÖêÏ∏† Í∏∞Îä•
 */

(function() {
    'use strict';
    
    function waitForBase(callback) {
        if (window.BoardTemplatesPluginBase && window.btRegisterPlugin) {
            callback();
        } else {
            setTimeout(() => waitForBase(callback), 100);
        }
    }
    
    waitForBase(function() {
        btRegisterPlugin('accordion', {
            langPath: 'content.accordion',
            
            initialize: function(context) {
                this.context = context;
                this.log('Accordion ÌîåÎü¨Í∑∏Ïù∏ Ï¥àÍ∏∞Ìôî');
                
                this.addStyles(`
                    /* Accordion Î≤ÑÌäº Ïä§ÌÉÄÏùº */
                    .note-btn-accordion {
                        background: none !important;
                        border: none !important;
                        cursor: pointer;
                    }
                    .note-btn-accordion:hover {
                        background: var(--editor-accent, #FED7AA) !important;
                    }
                    .note-btn-accordion.active {
                        background: var(--editor-primary, #FBBF24) !important;
                        color: var(--editor-text, #111827) !important;
                    }
                    
                    /* Accordion Ïª®ÌÖåÏù¥ÎÑà */
                    .bt-accordion {
                        margin: 16px 0;
                        border: 1px solid #e5e7eb;
                        border-radius: 8px;
                        overflow: hidden;
                        background: white;
                        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                    }
                    
                    /* Accordion ÏïÑÏù¥ÌÖú */
                    .bt-accordion-item {
                        border-bottom: 1px solid #e5e7eb;
                        position: relative;
                    }
                    
                    .bt-accordion-item:last-child {
                        border-bottom: none;
                    }
                    
                    /* Accordion Ìó§Îçî */
                    .bt-accordion-header {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 16px 20px;
                        background: #f9fafb;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        user-select: none;
                        position: relative;
                    }
                    
                    .bt-accordion-header:hover {
                        background: #f3f4f6;
                    }
                    
                    .bt-accordion-header.active {
                        background: #eff6ff;
                        border-bottom: 1px solid #dbeafe;
                    }
                    
                    .bt-accordion-title {
                        flex: 1;
                        font-weight: 600;
                        font-size: 15px;
                        color: #374151;
                        outline: none;
                        border: none;
                        background: none;
                        padding: 0;
                        text-align: left;
                        cursor: text;
                    }
                    
                    .bt-accordion-title:focus {
                        outline: 2px solid #3b82f6;
                        outline-offset: 2px;
                        border-radius: 4px;
                    }
                    
                    .bt-accordion-icon {
                        font-size: 14px;
                        color: #6b7280;
                        transition: transform 0.2s ease;
                        margin-left: 12px;
                        pointer-events: none;
                    }
                    
                    .bt-accordion-header.active .bt-accordion-icon {
                        transform: rotate(180deg);
                    }
                    
                    /* Accordion ÏΩòÌÖêÏ∏† */
                    .bt-accordion-content {
                        max-height: 0;
                        overflow: hidden;
                        transition: max-height 0.3s ease-out;
                        background: white;
                    }
                    
                    .bt-accordion-content.active {
                        max-height: none;
                        transition: max-height 0.3s ease-in;
                    }
                    
                    .bt-accordion-body {
                        padding: 20px;
                        line-height: 1.6;
                        color: #374151;
                        outline: none;
                    }
                    
                    .bt-accordion-body:focus {
                        outline: 2px solid #3b82f6;
                        outline-offset: 2px;
                        border-radius: 4px;
                    }
                    
                    .bt-accordion-body p:first-child {
                        margin-top: 0;
                    }
                    
                    .bt-accordion-body p:last-child {
                        margin-bottom: 0;
                    }
                    
                    /* Ïª®Ìä∏Î°§ Î≤ÑÌäºÎì§ */
                    .bt-accordion-controls {
                        position: absolute;
                        top: 8px;
                        right: 8px;
                        display: none;
                        gap: 4px;
                    }
                    
                    .bt-accordion:hover .bt-accordion-controls {
                        display: flex;
                    }
                    
                    .bt-accordion-btn {
                        width: 24px;
                        height: 24px;
                        border: 1px solid #d1d5db;
                        background: white;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.2s;
                    }
                    
                    .bt-accordion-btn:hover {
                        background: #f3f4f6;
                        border-color: #9ca3af;
                    }
                    
                    .bt-accordion-btn.danger:hover {
                        background: #fee2e2;
                        border-color: #f87171;
                        color: #dc2626;
                    }
                    
                    .bt-accordion-btn.success:hover {
                        background: #dcfce7;
                        border-color: #4ade80;
                        color: #16a34a;
                    }
                    
                    /* Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥º */
                    .bt-accordion-content {
                        transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    }
                    
                    /* Î∞òÏùëÌòï */
                    @media (max-width: 768px) {
                        .bt-accordion-header {
                            padding: 12px 16px;
                        }
                        
                        .bt-accordion-body {
                            padding: 16px;
                        }
                        
                        .bt-accordion-title {
                            font-size: 14px;
                        }
                        
                        .bt-accordion-controls {
                            display: flex;
                            position: static;
                            margin-left: 8px;
                        }
                    }
                    
                    /* Ï†ëÍ∑ºÏÑ± */
                    .bt-accordion-header[aria-expanded="true"] .bt-accordion-icon {
                        transform: rotate(180deg);
                    }
                    
                    .bt-accordion-content[aria-hidden="false"] {
                        max-height: none;
                    }
                `, 'accordion-plugin-styles');
                
                // Ï†ÑÏó≠ Ìï®ÏàòÎì§ Îì±Î°ù
                this.setupGlobalHandlers();
            },
            
            createButton: function(context) {
                const self = this;
                
                return {
                    tooltip: this.getTooltip(context, 'ÏïÑÏΩîÎîîÏñ∏ (Ctrl+Shift+A)'),
                    click: function() {
                        self.insertAccordion(context);
                    },
                    render: function() {
                        return '<button type="button" class="btn btn-light btn-sm note-btn-accordion" ' +
                               'title="' + self.getTooltip(context, 'ÏïÑÏΩîÎîîÏñ∏ (Ctrl+Shift+A)') + '" ' +
                               'tabindex="0">üìÅ ÏïÑÏΩîÎîîÏñ∏</button>';
                    }
                };
            },
            
            events: {
                'summernote.keydown': function(we, e) {
                    if (e.ctrlKey && e.shiftKey && e.keyCode === 65) { // Ctrl+Shift+A
                        e.preventDefault();
                        this.insertAccordion(this.context);
                        return false;
                    }
                }
            },
            
            insertAccordion: function(context) {
                try {
                    const accordionId = 'accordion_' + Date.now();
                    
                    const html = this.createAccordionHTML(accordionId, [
                        {
                            title: 'Ï≤´ Î≤àÏß∏ ÏÑπÏÖò',
                            content: 'Ïó¨Í∏∞Ïóê Ï≤´ Î≤àÏß∏ ÏÑπÏÖòÏùò ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.',
                            expanded: false
                        },
                        {
                            title: 'Îëê Î≤àÏß∏ ÏÑπÏÖò',
                            content: 'Ïó¨Í∏∞Ïóê Îëê Î≤àÏß∏ ÏÑπÏÖòÏùò ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.',
                            expanded: true
                        },
                        {
                            title: 'ÏÑ∏ Î≤àÏß∏ ÏÑπÏÖò',
                            content: 'Ïó¨Í∏∞Ïóê ÏÑ∏ Î≤àÏß∏ ÏÑπÏÖòÏùò ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.',
                            expanded: false
                        }
                    ]);
                    
                    this.insertHTML(context, html);
                    this.focus(context);
                    
                    // Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ ÏÑ§Ï†ï
                    setTimeout(() => this.setupAccordionEvents(accordionId), 100);
                    
                    this.log('ÏïÑÏΩîÎîîÏñ∏ ÏÇΩÏûÖ ÏôÑÎ£å');
                    
                } catch (error) {
                    this.handleError(error, 'insertAccordion');
                }
            },
            
            createAccordionHTML: function(accordionId, items) {
                let html = `<div class="bt-accordion" id="${accordionId}">
                    <div class="bt-accordion-controls">
                        <button class="bt-accordion-btn success" onclick="window.btAddAccordionItem('${accordionId}')" title="ÏïÑÏù¥ÌÖú Ï∂îÍ∞Ä">+</button>
                        <button class="bt-accordion-btn danger" onclick="window.btRemoveAccordion('${accordionId}')" title="ÏÇ≠Ï†ú">‚úï</button>
                    </div>`;
                
                items.forEach((item, index) => {
                    const itemId = `${accordionId}_item_${index}`;
                    const isExpanded = item.expanded;
                    const activeClass = isExpanded ? 'active' : '';
                    const ariaExpanded = isExpanded ? 'true' : 'false';
                    const ariaHidden = isExpanded ? 'false' : 'true';
                    
                    html += `
                        <div class="bt-accordion-item" data-item-id="${itemId}">
                            <div class="bt-accordion-header ${activeClass}" 
                                 onclick="window.btToggleAccordionItem('${itemId}')"
                                 role="button" 
                                 aria-expanded="${ariaExpanded}"
                                 tabindex="0">
                                <input type="text" class="bt-accordion-title" 
                                       value="${item.title}" 
                                       onclick="event.stopPropagation()"
                                       onkeydown="if(event.key==='Enter'){this.blur();window.btToggleAccordionItem('${itemId}')}"
                                       placeholder="Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                                <span class="bt-accordion-icon">‚ñº</span>
                            </div>
                            <div class="bt-accordion-content ${activeClass}" 
                                 aria-hidden="${ariaHidden}" 
                                 role="region">
                                <div class="bt-accordion-body" 
                                     contenteditable="true" 
                                     onclick="event.stopPropagation()">
                                    ${item.content}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div><p><br></p>`;
                return html;
            },
            
            setupAccordionEvents: function(accordionId) {
                // ÌÇ§Î≥¥Îìú Ï†ëÍ∑ºÏÑ±
                $(`#${accordionId} .bt-accordion-header`).on('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        $(this).click();
                    }
                });
                
                // Ï†úÎ™© ÏûÖÎ†• Ïãú Ïù¥Î≤§Ìä∏ Ï†ÑÌåå Î∞©ÏßÄ
                $(`#${accordionId} .bt-accordion-title`).on('click keydown', function(e) {
                    e.stopPropagation();
                });
                
                // ÏΩòÌÖêÏ∏† ÏòÅÏó≠ ÌÅ¥Î¶≠ Ïãú Ïù¥Î≤§Ìä∏ Ï†ÑÌåå Î∞©ÏßÄ
                $(`#${accordionId} .bt-accordion-body`).on('click', function(e) {
                    e.stopPropagation();
                });
            },
            
            setupGlobalHandlers: function() {
                const self = this;
                
                // ÏïÑÏΩîÎîîÏñ∏ ÏïÑÏù¥ÌÖú ÌÜ†Í∏Ä
                window.btToggleAccordionItem = function(itemId) {
                    const $item = $(`[data-item-id="${itemId}"]`);
                    const $header = $item.find('.bt-accordion-header');
                    const $content = $item.find('.bt-accordion-content');
                    
                    const isActive = $header.hasClass('active');
                    
                    if (isActive) {
                        // Ï†ëÍ∏∞
                        $header.removeClass('active').attr('aria-expanded', 'false');
                        $content.removeClass('active').attr('aria-hidden', 'true');
                        
                        // Ïï†ÎãàÎ©îÏù¥ÏÖòÏùÑ ÏúÑÌïú max-height ÏÑ§Ï†ï
                        const contentHeight = $content[0].scrollHeight;
                        $content.css('max-height', contentHeight + 'px');
                        
                        setTimeout(() => {
                            $content.css('max-height', '0px');
                        }, 10);
                        
                        self.log('ÏïÑÏΩîÎîîÏñ∏ ÏïÑÏù¥ÌÖú Ï†ëÌûò');
                    } else {
                        // ÌéºÏπòÍ∏∞
                        $header.addClass('active').attr('aria-expanded', 'true');
                        $content.addClass('active').attr('aria-hidden', 'false');
                        
                        // Ïï†ÎãàÎ©îÏù¥ÏÖòÏùÑ ÏúÑÌïú max-height ÏÑ§Ï†ï
                        const contentHeight = $content[0].scrollHeight;
                        $content.css('max-height', contentHeight + 'px');
                        
                        // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏôÑÎ£å ÌõÑ max-height Ï†úÍ±∞
                        setTimeout(() => {
                            $content.css('max-height', 'none');
                        }, 300);
                        
                        self.log('ÏïÑÏΩîÎîîÏñ∏ ÏïÑÏù¥ÌÖú ÌéºÏπ®');
                    }
                };
                
                // ÏïÑÏΩîÎîîÏñ∏ ÏïÑÏù¥ÌÖú Ï∂îÍ∞Ä
                window.btAddAccordionItem = function(accordionId) {
                    const $accordion = $(`#${accordionId}`);
                    const itemCount = $accordion.find('.bt-accordion-item').length;
                    const newItemId = `${accordionId}_item_${itemCount}`;
                    
                    const newItemHTML = `
                        <div class="bt-accordion-item" data-item-id="${newItemId}">
                            <div class="bt-accordion-header" 
                                 onclick="window.btToggleAccordionItem('${newItemId}')"
                                 role="button" 
                                 aria-expanded="false"
                                 tabindex="0">
                                <input type="text" class="bt-accordion-title" 
                                       value="ÏÉàÎ°úÏö¥ ÏÑπÏÖò" 
                                       onclick="event.stopPropagation()"
                                       onkeydown="if(event.key==='Enter'){this.blur();window.btToggleAccordionItem('${newItemId}')}"
                                       placeholder="Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                                <span class="bt-accordion-icon">‚ñº</span>
                            </div>
                            <div class="bt-accordion-content" 
                                 aria-hidden="true" 
                                 role="region">
                                <div class="bt-accordion-body" 
                                     contenteditable="true" 
                                     onclick="event.stopPropagation()">
                                    Ïó¨Í∏∞Ïóê ÏÉàÎ°úÏö¥ ÏÑπÏÖòÏùò ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.
                                </div>
                            </div>
                        </div>
                    `;
                    
                    $accordion.append(newItemHTML);
                    
                    // ÏÉà ÏïÑÏù¥ÌÖú Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
                    self.setupAccordionEvents(accordionId);
                    
                    // ÏÉà ÏïÑÏù¥ÌÖú Ï†úÎ™©Ïóê Ìè¨Ïª§Ïä§
                    setTimeout(() => {
                        const $newTitle = $(`[data-item-id="${newItemId}"] .bt-accordion-title`);
                        $newTitle.focus().select();
                    }, 50);
                    
                    self.log('ÏïÑÏΩîÎîîÏñ∏ ÏïÑÏù¥ÌÖú Ï∂îÍ∞ÄÎê®');
                };
                
                // ÏïÑÏΩîÎîîÏñ∏ ÏÇ≠Ï†ú
                window.btRemoveAccordion = function(accordionId) {
                    if (confirm('Ïù¥ ÏïÑÏΩîÎîîÏñ∏ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        $(`#${accordionId}`).remove();
                        self.log('ÏïÑÏΩîÎîîÏñ∏ ÏÇ≠Ï†úÎê®');
                    }
                };
            },
            
            createHelp: function(context) {
                return {
                    title: 'ÏïÑÏΩîÎîîÏñ∏',
                    content: [
                        '<h4>ÏïÑÏΩîÎîîÏñ∏ Í∏∞Îä•</h4>',
                        '<p>Ï†ëÍ±∞ÎÇò ÌéºÏπ† Ïàò ÏûàÎäî ÏΩòÌÖêÏ∏† ÏÑπÏÖòÏùÑ ÎßåÎì§ Ïàò ÏûàÏäµÎãàÎã§.</p>',
                        '<ul>',
                        '<li><strong>Îã®Ï∂ïÌÇ§:</strong> Ctrl+Shift+A</li>',
                        '<li><strong>Ìó§Îçî ÌÅ¥Î¶≠:</strong> ÏÑπÏÖò ÌÜ†Í∏Ä (Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞)</li>',
                        '<li><strong>Ï†úÎ™© Ìé∏Ïßë:</strong> Ìó§Îçî Ï†úÎ™© ÏßÅÏ†ë Ìé∏Ïßë Í∞ÄÎä•</li>',
                        '<li><strong>ÎÇ¥Ïö© Ìé∏Ïßë:</strong> ÏÑπÏÖò ÎÇ¥Ïö© ÏßÅÏ†ë Ìé∏Ïßë Í∞ÄÎä•</li>',
                        '<li><strong>ÏïÑÏù¥ÌÖú Ï∂îÍ∞Ä:</strong> + Î≤ÑÌäºÏúºÎ°ú ÏÉà ÏÑπÏÖò Ï∂îÍ∞Ä</li>',
                        '<li><strong>ÏÇ≠Ï†ú:</strong> ‚úï Î≤ÑÌäºÏúºÎ°ú Ï†ÑÏ≤¥ ÏïÑÏΩîÎîîÏñ∏ ÏÇ≠Ï†ú</li>',
                        '</ul>',
                        '<h5>Ï†ëÍ∑ºÏÑ± ÏßÄÏõê</h5>',
                        '<ul>',
                        '<li><strong>ÌÇ§Î≥¥Îìú:</strong> Tab, Enter, Space ÌÇ§ ÏßÄÏõê</li>',
                        '<li><strong>Ïä§ÌÅ¨Î¶∞ Î¶¨Îçî:</strong> ARIA ÏÜçÏÑ± ÏßÄÏõê</li>',
                        '<li><strong>Î™®Î∞îÏùº:</strong> ÌÑ∞Ïπò Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ ÏµúÏ†ÅÌôî</li>',
                        '</ul>',
                        '<p><strong>ÌôúÏö©:</strong> FAQ, Îã®Í≥ÑÎ≥Ñ Í∞ÄÏù¥Îìú, Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Ï†ïÎ≥¥ Ï†ïÎ¶¨ Îì±Ïóê Ïú†Ïö©Ìï©ÎãàÎã§.</p>'
                    ].join('')
                };
            }
        });
        
        if (typeof $ !== 'undefined' && $(document)) {
            $(document).trigger('board-templates-plugin-loaded', ['accordion']);
        }
    });
    
})();