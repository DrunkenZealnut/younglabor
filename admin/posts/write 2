<?php
include '../auth.php'; // ê´€ë¦¬ì ì¸ì¦ í™•ì¸
require_once '../db.php'; // DB ì—°ê²°
require_once 'processContentImages.php'; // ì´ë¯¸ì§€ ì²˜ë¦¬ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜

// ê´€ë¦¬ì ì‚¬ìš©ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
$admin_username = $_SESSION['admin_username'] ?? 'ê´€ë¦¬ì';

// ê²Œì‹œíŒ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìº˜ë¦°ë” íƒ€ì… ì œì™¸) - prepared statement ì‚¬ìš©
$stmt = $pdo->prepare("SELECT id, board_name, write_level FROM hopec_boards WHERE board_type != ? ORDER BY board_name ASC");
$stmt->execute(['calendar']);
$boards = $stmt->fetchAll(PDO::FETCH_ASSOC);

// í™˜ê²½ë³€ìˆ˜ ë¡œë” í¬í•¨
require_once __DIR__ . '/../../includes/env_loader.php';

// í˜ì´ìŠ¤ë¶ API ì •ë³´ (í™˜ê²½ ë³€ìˆ˜ì—ì„œ ë¡œë“œ)
$fb_app_id = env('FACEBOOK_APP_ID', '2167678457006984');
$fb_app_secret = env('FACEBOOK_APP_SECRET', '15be077b027bd3ed138f7230b5d389bd');
$fb_page_id = env('FACEBOOK_PAGE_ID', '1465916713640208');
$fb_access_token = env('FACEBOOK_ACCESS_TOKEN', 'EAAezffhqy4gBO04HX7RghZCWNcYhCS6DoPS4YbiZACxUGhEWVtfZBzi0VQo4dQFUKzCYzZCXmw7ZCicW0zdviAAILRWLPasCL8SHJZC7rFYNGxTbNWnj1ZCZA0L3pvLTWuZAxt9eaeotmL2iKeYnsoTEVFuWX2XbmUhOEdRFlfKCCeDZChdAb3sDqe3gpnqjIZC');

// ê²Œì‹œê¸€ ì €ì¥ ì²˜ë¦¬
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // í¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    $board_id = (int)$_POST['board_id'];
    $category_id = isset($_POST['category_id']) ? (int)$_POST['category_id'] : NULL;
    $title = trim($_POST['title']);
    
    // HTML ì½˜í…ì¸  ê¸°ë³¸ ê²€ì¦ ë° ì •ë¦¬
    $content = $_POST['content'];
    // ê¸°ë³¸ì ì¸ XSS ë°©ì§€: ìœ„í—˜í•œ ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ì œê±°
    $content = preg_replace('/<script[^>]*?>.*?<\/script>/is', '', $content);
    $content = preg_replace('/javascript:/i', '', $content);
    $content = preg_replace('/on\w+\s*=/i', '', $content); // onclick, onload ë“± ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì œê±°
    
    $author = trim($_POST['author']);
    $is_notice = isset($_POST['is_notice']) ? 1 : 0;
    $is_published = isset($_POST['is_published']) ? 1 : 0;
    $post_to_facebook = isset($_POST['post_to_facebook']) ? 1 : 0;
    
    // í¼ ìœ íš¨ì„± ê²€ì‚¬
    $errors = [];
    
    if (empty($board_id)) {
        $errors[] = "ê²Œì‹œíŒì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
    }
    
    if (empty($title)) {
        $errors[] = "ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
    }
    
    // ë³¸ë¬¸ í•„ìˆ˜ ì…ë ¥ ì¡°ê±´ ì œê±°
    // if (empty($content)) {
    //     $errors[] = "ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
    // }
    
    if (empty($author)) {
        $errors[] = "ì‘ì„±ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
    }
    
    // ì¸ë„¤ì¼ ì´ë¯¸ì§€ ì²˜ë¦¬
    $thumbnail = null;
    if (!empty($_FILES['thumbnail']['name'])) {
        // ì—°ë„/ì›” í´ë” êµ¬ì¡° ìƒì„±
        $date = new DateTime();
        $year = $date->format('Y');
        $month = $date->format('m');
        $upload_dir = "../../uploads/posts/$year/$month/";
        
        // ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ìƒì„±
        if (!is_dir($upload_dir)) {
            mkdir($upload_dir, 0755, true);
        }
        
        // íŒŒì¼ëª… ìƒì„± - ë‚ ì§œ ì‹œê°„ í˜•ì‹ê³¼ ê³ ìœ  ID ì¡°í•©
        $date_str = date('YmdHis'); // ë…„ì›”ì¼ì‹œë¶„ì´ˆ í˜•ì‹
        $file_ext = strtolower(pathinfo($_FILES['thumbnail']['name'], PATHINFO_EXTENSION));
        $unique_id = uniqid();
        $thumbnail_name = "{$date_str}_{$unique_id}.{$file_ext}";
        $thumbnail_path = $upload_dir . $thumbnail_name;
        
        // ì´ë¯¸ì§€ íƒ€ì… í™•ì¸ (í™•ì¥ì + MIME íƒ€ì… ê²€ì¦)
        $allowed_extensions = ['jpg', 'jpeg', 'png', 'gif'];
        $allowed_mime_types = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        
        // í™•ì¥ì ê²€ì¦
        if (!in_array($file_ext, $allowed_extensions)) {
            $errors[] = "ì¸ë„¤ì¼ì€ JPG, JPEG, PNG, GIF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
        } else {
            // MIME íƒ€ì… ê²€ì¦ (ë³´ì•ˆ ê°•í™”)
            $finfo = new finfo(FILEINFO_MIME_TYPE);
            $detected_mime = $finfo->file($_FILES['thumbnail']['tmp_name']);
            
            if (!in_array($detected_mime, $allowed_mime_types)) {
                $errors[] = "ì—…ë¡œë“œëœ íŒŒì¼ì´ ì‹¤ì œ ì´ë¯¸ì§€ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤. (ê°ì§€ëœ íƒ€ì…: " . $detected_mime . ")";
            } else {
                // íŒŒì¼ ì—…ë¡œë“œ
                if (move_uploaded_file($_FILES['thumbnail']['tmp_name'], $thumbnail_path)) {
                    $thumbnail = "uploads/posts/$year/$month/" . $thumbnail_name;
                } else {
                    $errors[] = "ì¸ë„¤ì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                }
            }
        }
    } else {
        // ì¸ë„¤ì¼ì´ ì—†ëŠ” ê²½ìš° ì‚¬ì´íŠ¸ ë¡œê³ ë¥¼ ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ì‚¬ìš©
        // ì‚¬ì´íŠ¸ ì„¤ì •ì—ì„œ ë¡œê³  ì •ë³´ ê°€ì ¸ì˜¤ê¸° - prepared statement ì‚¬ìš©
        $settings_stmt = $pdo->prepare("SELECT setting_value FROM hopec_site_settings WHERE setting_key = ?");
        $settings_stmt->execute(['site_logo']);
        $logo_setting = $settings_stmt->fetch(PDO::FETCH_ASSOC);
        
        // ë¡œê³ ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë¡œê³ ë¥¼ ì¸ë„¤ì¼ë¡œ ì‚¬ìš©
        if ($logo_setting && !empty($logo_setting['setting_value'])) {
            // ê²½ë¡œê°€ ì´ë¯¸ 'uploads/'ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸í•˜ê³ , ê²½ë¡œ ì¤‘ë³µì„ ë°©ì§€í•©ë‹ˆë‹¤
            $logo_path = $logo_setting['setting_value'];
            $thumbnail = $logo_path; // ë¡œê³  ê²½ë¡œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì´ë¯¸ 'uploads/settings/'ë¡œ ì‹œì‘í•¨)
        }
    }
    
    // ì˜¤ë¥˜ê°€ ì—†ìœ¼ë©´ ê²Œì‹œê¸€ ì €ì¥
    if (empty($errors)) {
        try {
            $stmt = $pdo->prepare("
                INSERT INTO hopec_posts 
                (board_id, category_id, title, content, author, is_notice, is_published, thumbnail, created_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, NOW())
            ");
            
            $result = $stmt->execute([
                $board_id, $category_id, $title, $content, $author, $is_notice, $is_published, $thumbnail
            ]);
            
            if ($result) {
                $post_id = $pdo->lastInsertId();
                
                // ì½˜í…ì¸ ì—ì„œ ì„ì‹œ ì´ë¯¸ì§€ë¥¼ ì‹¤ì œ DBì— ì—°ê²°
                $content = processContentImages($content, $post_id, $pdo);
                
                // ì½˜í…ì¸  ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€ ê²½ë¡œê°€ ìˆ˜ì •ë˜ì—ˆì„ ìˆ˜ ìˆìŒ)
                $update_stmt = $pdo->prepare("UPDATE hopec_posts SET content = ? WHERE id = ?");
                $update_stmt->execute([$content, $post_id]);
                
                // ë³¸ë¬¸ì— ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ì„œ ì¸ë„¤ì¼ì´ ì‚¬ì´íŠ¸ ë¡œê³ ì¸ ê²½ìš° ì²« ë²ˆì§¸ ì´ë¯¸ì§€ë¥¼ ì¸ë„¤ì¼ë¡œ ì„¤ì •
                $thumbnail_updated = updateThumbnailFromContent($content, $post_id, $thumbnail, $pdo);
                
                // ì¸ë„¤ì¼ ì—…ë°ì´íŠ¸ê°€ ì‹¤íŒ¨í–ˆê³ (ë³¸ë¬¸ì— ì´ë¯¸ì§€ê°€ ì—†ê³ ), ì¸ë„¤ì¼ë„ ì—†ëŠ” ê²½ìš°
                // í•­ìƒ ì‚¬ì´íŠ¸ ë¡œê³ ë¥¼ ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ì‚¬ìš©
                if (!$thumbnail_updated && empty($thumbnail)) {
                    $settings_stmt = $pdo->prepare("SELECT setting_value FROM hopec_site_settings WHERE setting_key = ?");
                    $settings_stmt->execute(['site_logo']);
                    $logo_setting = $settings_stmt->fetch(PDO::FETCH_ASSOC);
                    
                    if ($logo_setting && !empty($logo_setting['setting_value'])) {
                        $logo_path = $logo_setting['setting_value'];
                        $thumbnail = $logo_path;
                        
                        // ì¸ë„¤ì¼ ì—…ë°ì´íŠ¸
                        $update_thumb_stmt = $pdo->prepare("UPDATE hopec_posts SET thumbnail = ? WHERE id = ?");
                        $update_thumb_stmt->execute([$thumbnail, $post_id]);
                    }
                }
                
                // ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬
                if (isset($_POST['allow_attachments']) && $_POST['allow_attachments'] === 'true' && !empty($_FILES['attachments']['name'][0])) {
                    // ì—°ë„/ì›” í´ë” êµ¬ì¡° ìƒì„±
                    $date = new DateTime();
                    $year = $date->format('Y');
                    $month = $date->format('m');
                    $uploads_dir = "../../uploads/posts/$year/$month";
                    
                    // ë””ë ‰í† ë¦¬ê°€ ì—†ëŠ” ê²½ìš° ìƒì„±
                    if (!is_dir($uploads_dir)) {
                        mkdir($uploads_dir, 0755, true);
                    }
                    
                    $file_count = count($_FILES['attachments']['name']);
                    
                    for ($i = 0; $i < $file_count; $i++) {
                        if ($_FILES['attachments']['error'][$i] === UPLOAD_ERR_OK) {
                            $tmp_name = $_FILES['attachments']['tmp_name'][$i];
                            $name = $_FILES['attachments']['name'][$i];
                            $file_size = $_FILES['attachments']['size'][$i];
                            $file_type = $_FILES['attachments']['type'][$i];
                            
                            // íŒŒì¼ëª… ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ ë° postID í¬í•¨
                            $file_ext = strtolower(pathinfo($name, PATHINFO_EXTENSION));
                            $date_str = date('YmdHis'); // ë…„ì›”ì¼ì‹œë¶„ì´ˆ í˜•ì‹
                            $unique_id = uniqid();
                            $safe_filename = "{$date_str}_{$unique_id}.{$file_ext}";
                            
                            // íŒŒì¼ ì €ì¥
                            $dest_path = $uploads_dir . '/' . $safe_filename;
                            
                            if (move_uploaded_file($tmp_name, $dest_path)) {
                                // DBì— ì²¨ë¶€íŒŒì¼ ì •ë³´ ì €ì¥
                                $file_stmt = $pdo->prepare("
                                    INSERT INTO hopec_post_attachments 
                                    (post_id, file_name, file_path, file_size, file_type)
                                    VALUES (?, ?, ?, ?, ?)
                                ");
                                
                                $file_path = "uploads/posts/$year/$month/" . $safe_filename;
                                $file_stmt->execute([$post_id, $name, $file_path, $file_size, $file_type]);
                            } else {
                            }
                        }
                    }
                }
                
                // í˜ì´ìŠ¤ë¶ í˜ì´ì§€ì— ì—…ë¡œë“œ
                if ($post_to_facebook) {
                    // ì´ë¯¸ì§€ URL ì¶”ì¶œ
                    preg_match_all('/<img[^>]+src="([^"]+)"[^>]*>/i', $content, $matches);
                    $image_urls = [];
                    
                    if (isset($matches[1])) {
                        foreach ($matches[1] as $img_url) {
                            // ì„œë²„ì— ìˆëŠ” ì´ë¯¸ì§€ URLì„ ì™„ì „í•œ URLë¡œ ë³€í™˜
                            if (strpos($img_url, 'http') === 0) {
                                // ì´ë¯¸ HTTPë¡œ ì‹œì‘í•˜ëŠ” URLì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                                $image_urls[] = $img_url;
                            } else {
                                // ìƒëŒ€ ê²½ë¡œ ì´ë¯¸ì§€ëŠ” ì „ì²´ ë„ë©”ì¸ì„ í¬í•¨í•œ URLë¡œ ë³€í™˜
                                $full_url = 'http://' . $_SERVER['HTTP_HOST'] . '/' . ltrim(str_replace('../../', '', $img_url), '/');
                                $image_urls[] = $full_url;
                            }
                        }
                    }
                    
                    // í˜ì´ìŠ¤ë¶ì— ê²Œì‹œë¬¼ ì—…ë¡œë“œ
                    $message = $title . "\n\n" . strip_tags($content);
                    
                    // ë””ë²„ê¹… ì •ë³´ íŒŒì¼ì— ê¸°ë¡
                    $log_file = '../logs/facebook_upload_log.txt';
                    $log_data = date('Y-m-d H:i:s') . " - ê²Œì‹œê¸€ ID: " . $post_id . "\n";
                    $log_data .= "ì œëª©: " . $title . "\n";
                    $log_data .= "ì´ë¯¸ì§€ URL ìˆ˜: " . count($image_urls) . "\n";
                    
                    if (!empty($image_urls)) {
                        $log_data .= "ì²«ë²ˆì§¸ ì´ë¯¸ì§€ URL: " . $image_urls[0] . "\n";
                        
                        // ì´ë¯¸ì§€ íŒŒì¼ì„ ì§ì ‘ ì—…ë¡œë“œí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½
                        $img_url = $image_urls[0];
                        
                        // ìƒëŒ€ê²½ë¡œë¥¼ ì„œë²„ ì ˆëŒ€ê²½ë¡œë¡œ ë³€í™˜
                        $server_path = '';
                        if (strpos($img_url, 'http') === 0) {
                            // URLì—ì„œ íŒŒì¼ê²½ë¡œ ì¶”ì¶œ
                            $parsed_url = parse_url($img_url);
                            $relative_path = $parsed_url['path'];
                            $server_path = $_SERVER['DOCUMENT_ROOT'] . $relative_path;
                        } else {
                            // ìƒëŒ€ê²½ë¡œë¥¼ ì ˆëŒ€ê²½ë¡œë¡œ ë³€í™˜
                            $server_path = $_SERVER['DOCUMENT_ROOT'] . '/' . ltrim(str_replace('../../', '', $img_url), '/');
                        }
                        
                        $log_data .= "ì„œë²„ ê²½ë¡œ: " . $server_path . "\n";
                        
                        // íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                        if (file_exists($server_path)) {
                            $log_data .= "íŒŒì¼ ì¡´ì¬í•¨\n";
                            
                            // í˜ì´ìŠ¤ë¶ì— ì§ì ‘ íŒŒì¼ ì—…ë¡œë“œ
                            $url = "https://graph.facebook.com/v18.0/{$fb_page_id}/photos";
                            
                            // cURLë¡œ ë©€í‹°íŒŒíŠ¸ í¼ ë°ì´í„° ì—…ë¡œë“œ
                            $data = [
                                'message' => $message,
                                'access_token' => $fb_access_token,
                                'source' => new CURLFile($server_path)
                            ];
                            
                            $ch = curl_init();
                            curl_setopt($ch, CURLOPT_URL, $url);
                            curl_setopt($ch, CURLOPT_POST, 1);
                            curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                            $response = curl_exec($ch);
                            $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                            curl_close($ch);
                        } else {
                            $log_data .= "íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ\n";
                            
                            // ì´ë¯¸ì§€ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš°, í…ìŠ¤íŠ¸ë§Œ ì—…ë¡œë“œ
                            $url = "https://graph.facebook.com/v18.0/{$fb_page_id}/feed";
                            $data = [
                                'message' => $message,
                                'access_token' => $fb_access_token
                            ];
                            
                            $ch = curl_init();
                            curl_setopt($ch, CURLOPT_URL, $url);
                            curl_setopt($ch, CURLOPT_POST, 1);
                            curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
                            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                            $response = curl_exec($ch);
                            $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                            curl_close($ch);
                        }
                        
                        // ì‘ë‹µ ë¡œê¹…
                        $log_data .= "API í˜¸ì¶œ ê²°ê³¼ (photos): HTTP " . $http_code . "\n";
                        $log_data .= "ì‘ë‹µ: " . $response . "\n";
                    } else {
                        $log_data .= "ì´ë¯¸ì§€ ì—†ìŒ, í…ìŠ¤íŠ¸ë§Œ ì—…ë¡œë“œ\n";
                        
                        // ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš° ì¼ë°˜ ê²Œì‹œë¬¼ë¡œ ì—…ë¡œë“œ
                        $url = "https://graph.facebook.com/v18.0/{$fb_page_id}/feed";
                        $data = [
                            'message' => $message,
                            'access_token' => $fb_access_token
                        ];
                        
                        $ch = curl_init();
                        curl_setopt($ch, CURLOPT_URL, $url);
                        curl_setopt($ch, CURLOPT_POST, 1);
                        curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                        $response = curl_exec($ch);
                        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                        curl_close($ch);
                        
                        // ì‘ë‹µ ë¡œê¹…
                        $log_data .= "API í˜¸ì¶œ ê²°ê³¼ (feed): HTTP " . $http_code . "\n";
                        $log_data .= "ì‘ë‹µ: " . $response . "\n";
                    }
                    
                    // ë¡œê·¸ ì €ì¥
                    if (!is_dir('../logs')) {
                        mkdir('../logs', 0755, true);
                    }
                    file_put_contents($log_file, $log_data . "\n---\n", FILE_APPEND);
                }
                
                // ì„±ê³µ ë©”ì‹œì§€ ë° ë¦¬ë””ë ‰ì…˜
                $_SESSION['success_message'] = "ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
                header("Location: list.php");
                exit;
            }
        } catch (PDOException $e) {
            $errors[] = "ê²Œì‹œê¸€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " . $e->getMessage();
        }
    }
}


?>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìƒˆ ê²Œì‹œê¸€ ì‘ì„± - ê´€ë¦¬ì</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <!-- Summernote CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.css">
  
  <!-- Enhanced Editor CSS -->
  <link rel="stylesheet" href="../../board_templates/css/editor-enhancements.css">
  
  <style>
    body {
      min-height: 100vh;
      display: flex;
      font-family: 'Segoe UI', sans-serif;
    }
    .sidebar {
      width: 220px;
      background-color: #343a40;
      color: white;
      min-height: 100vh;
    }
    .sidebar a {
      color: white;
      padding: 12px 16px;
      display: block;
      text-decoration: none;
    }
    .sidebar a:hover {
      background-color: #495057;
    }
    .main-content {
      flex-grow: 1;
      padding: 30px;
      background-color: #f8f9fa;
    }
    .sidebar .logo {
      font-weight: bold;
      font-size: 1.3rem;
      padding: 16px;
      border-bottom: 1px solid #495057;
    }
    
    /* ë©”ì¸ í˜ì´ì§€ì™€ ë™ì¼í•œ ì—ë””í„° ìŠ¤íƒ€ì¼ */
    .note-editor {
      border-radius: 5px;
      overflow: hidden;
      border: 2px solid #0d6efd !important;
      margin-bottom: 0;
    }
    
    .note-editor .note-editable {
      background-color: #fff;
      min-height: 400px;
    }
    
    .note-toolbar {
      background-color: #f8f9fa;
    }
    
    .note-editor .note-toolbar .note-btn {
      background-color: #fff;
      border-color: #ced4da;
    }
    
    .note-editor .note-toolbar .note-btn:hover {
      background-color: #e9ecef;
    }
    
    /* ì´ë¯¸ì§€ ì‚½ì… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .note-modal {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      z-index: 9999 !important;
      width: auto !important;
      max-width: 90% !important;
      min-width: 350px !important;
      height: auto !important;
    }
    
    .note-modal-content {
      border-radius: 8px !important;
      overflow: hidden !important;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15) !important;
      border: none !important;
      width: 100% !important;
      height: auto !important;
    }
    
    .note-modal-header {
      background-color: #f8f9fa !important;
      border-bottom: 1px solid #dee2e6 !important;
      padding: 15px !important;
    }
    
    .note-modal-title {
      font-weight: bold !important;
      color: #212529 !important;
      font-size: 18px !important;
    }
    
    .note-modal-body {
      padding: 20px !important;
      background-color: #ffffff !important;
      max-height: 70vh !important;
      overflow-y: auto !important;
    }
    
    .note-modal-footer {
      background-color: #f8f9fa !important;
      border-top: 1px solid #dee2e6 !important;
      padding: 15px !important;
      display: flex !important;
      justify-content: center !important;
      position: relative !important;
      width: 100% !important;
      min-height: 60px !important;
    }
    
    .note-modal-footer .btn {
      margin: 0 5px !important;
      padding: 8px 16px !important;
      border-radius: 4px !important;
      font-weight: 500 !important;
      white-space: nowrap !important;
      min-width: 80px !important;
    }
    
    .note-modal-footer .btn-primary {
      background-color: #0d6efd !important;
      border-color: #0d6efd !important;
      color: #fff !important;
    }
    
    /* URL ì…ë ¥ í•„ë“œ ê°•í™” */
    .note-image-url {
      width: 100% !important;
      padding: 12px !important;
      border: 2px solid #80bdff !important;
      border-radius: 4px !important;
      background-color: #fff !important;
      font-size: 14px !important;
      height: auto !important;
      box-shadow: 0 0 8px rgba(0, 123, 255, 0.15) !important;
      margin: 10px 0 5px 0 !important;
    }
    
    .note-group-image-url {
      background-color: #f0f7ff !important;
      padding: 15px !important;
      border-radius: 4px !important;
      border: 1px solid #b8daff !important;
      margin-bottom: 10px !important;
    }
    
    .note-group-image-url label {
      font-size: 15px !important;
      color: #212529 !important;
      font-weight: bold !important;
      margin-bottom: 10px !important;
      display: block !important;
      border-bottom: 1px solid #dee2e6 !important;
      padding-bottom: 8px !important;
    }
    
    .note-group-select-from-files {
      background-color: #f5f5f5 !important;
      padding: 15px !important;
      border-radius: 4px !important;
      border: 1px solid #e0e0e0 !important;
      margin: 15px 0 !important;
    }
    
    .note-modal-backdrop {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      z-index: 9998 !important;
      background-color: rgba(0, 0, 0, 0.5) !important;
    }
    
    /* ëª¨ë°”ì¼ì—ì„œ ëª¨ë‹¬ í¬ê¸° ìµœì í™” */
    @media (max-width: 576px) {
      .note-modal {
        width: 95% !important;
        min-width: 300px !important;
        height: auto !important;
      }
      
      .note-modal-body {
        padding: 15px !important;
        max-height: 62vh !important;
      }
      
      .note-modal-footer {
        padding: 10px !important;
        min-height: 50px !important;
      }
      
      .note-modal-footer .btn {
        padding: 6px 12px !important;
        font-size: 14px !important;
        min-width: 70px !important;
      }
    }
    
    .thumbnail-preview {
      max-width: 150px;
      max-height: 150px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<!-- ì‚¬ì´ë“œë°” -->
<div class="sidebar">
  <div class="logo">ìš°ë™615 ê´€ë¦¬ì</div>
  <a href="../index.php">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
  <a href="list.php" class="active" style="background-color: #495057;">ğŸ“ ê²Œì‹œê¸€ ê´€ë¦¬</a>
  <a href="../boards/list.php">ğŸ“‹ ê²Œì‹œíŒ ê´€ë¦¬</a>
  <a href="../menu/list.php">ğŸ§­ ë©”ë‰´ ê´€ë¦¬</a>
  <a href="../inquiries/list.php">ğŸ“¬ ë¬¸ì˜ ê´€ë¦¬</a>
  <a href="../events/list.php">ğŸ“… í–‰ì‚¬ ê´€ë¦¬</a>
  <a href="../files/list.php">ğŸ“‚ ìë£Œì‹¤</a>
  <a href="../settings/site_settings.php">ğŸ¨ ë””ìì¸ ì„¤ì •</a>
  <a href="../logout.php">ğŸšª ë¡œê·¸ì•„ì›ƒ</a>
</div>

<!-- ë³¸ë¬¸ -->
<div class="main-content">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="../index.php">ëŒ€ì‹œë³´ë“œ</a></li>
      <li class="breadcrumb-item"><a href="list.php">ê²Œì‹œê¸€ ê´€ë¦¬</a></li>
      <li class="breadcrumb-item active" aria-current="page">ìƒˆ ê²Œì‹œê¸€ ì‘ì„±</li>
    </ol>
  </nav>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>ìƒˆ ê²Œì‹œê¸€ ì‘ì„±</h2>
    <a href="list.php" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ
    </a>
  </div>
  
  <!-- ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ -->
  <?php if (!empty($errors)): ?>
    <div class="alert alert-danger">
      <ul class="mb-0">
        <?php foreach ($errors as $error): ?>
          <li><?= $error ?></li>
        <?php endforeach; ?>
      </ul>
    </div>
  <?php endif; ?>
  
  <!-- ê²Œì‹œê¸€ ì‘ì„± í¼ -->
  <div class="card">
    <div class="card-body">
      <form method="post" enctype="multipart/form-data">
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="board_id" class="form-label">ê²Œì‹œíŒ ì„ íƒ</label>
            <select class="form-select" id="board_id" name="board_id" required>
              <option value="">-- ê²Œì‹œíŒ ì„ íƒ --</option>
              <?php foreach ($boards as $board): ?>
                <option value="<?= $board['id'] ?>"><?= htmlspecialchars($board['board_name']) ?></option>
              <?php endforeach; ?>
            </select>
          </div>
          <div class="col-md-6">
            <label for="author" class="form-label">ì‘ì„±ì</label>
            <input type="text" class="form-control" id="author" name="author" value="<?= htmlspecialchars($admin_username) ?>" required>
          </div>
        </div>
        
        <div id="category_container" class="mb-3 d-none">
          <label for="category_id" class="form-label">ì¹´í…Œê³ ë¦¬</label>
          <select class="form-select" id="category_id" name="category_id">
            <option value="">-- ì¹´í…Œê³ ë¦¬ ì„ íƒ --</option>
          </select>
        </div>
        
        <div class="mb-3">
          <label for="title" class="form-label">ì œëª©</label>
          <input type="text" class="form-control" id="title" name="title" required>
        </div>
        
        <div class="mb-3">
          <label for="content" class="form-label">ë‚´ìš©</label>
          <textarea id="summernote" name="content" class="summernote"></textarea>
        </div>
        
        <div class="mb-3">
          <label for="thumbnail" class="form-label">ì¸ë„¤ì¼ ì´ë¯¸ì§€</label>
          <input type="file" class="form-control" id="thumbnail" name="thumbnail" accept="image/*">
          <div class="form-text">ì¸ë„¤ì¼ë¡œ ì‚¬ìš©í•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”. (ì„ íƒì‚¬í•­)</div>
        </div>
        
        <!-- ì²¨ë¶€íŒŒì¼ ì˜ì—­ (ê²Œì‹œíŒ ì„¤ì •ì— ë”°ë¼ í‘œì‹œ) -->
        <div class="mb-3" id="attachments_container" style="display: block;">
          <label for="attachments" class="form-label">ì²¨ë¶€íŒŒì¼</label>
          <input type="file" class="form-control" id="attachments" name="attachments[]" multiple>
          <div class="form-text">
            ì²¨ë¶€í•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”. ì—¬ëŸ¬ íŒŒì¼ì„ í•œë²ˆì— ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì„ íƒì‚¬í•­)<br>
            ì²¨ë¶€ ê°€ëŠ¥í•œ íŒŒì¼: ë¬¸ì„œ(pdf, doc, docx, hwp, txt), ì´ë¯¸ì§€(jpg, jpeg, png, gif), ì••ì¶•íŒŒì¼(zip, rar) / ìµœëŒ€ 10MB
          </div>
          <input type="hidden" name="allow_attachments" id="allow_attachments" value="true">
        </div>
        
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="is_notice" name="is_notice">
          <label class="form-check-label" for="is_notice">
            ê³µì§€ì‚¬í•­ìœ¼ë¡œ ë“±ë¡
          </label>
        </div>
        
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="is_published" name="is_published" checked>
          <label class="form-check-label" for="is_published">
            ë°”ë¡œ ë°œí–‰í•˜ê¸° (ì²´í¬ í•´ì œì‹œ ì„ì‹œì €ì¥)
          </label>
        </div>
        
        <div class="form-check mb-3" id="facebook_post_container" style="display: none;">
          <input class="form-check-input" type="checkbox" id="post_to_facebook" name="post_to_facebook">
          <label class="form-check-label" for="post_to_facebook">
            í˜ì´ìŠ¤ë¶ í˜ì´ì§€ì—ë„ ì—…ë¡œë“œí•˜ê¸°
          </label>
        </div>
        
        <div class="d-flex justify-content-end">
          <button type="button" class="btn btn-light me-2" id="cancel-btn">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary">ì €ì¥</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ê¸°ë³¸ ëª¨ë‹¬ (ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë™ì ìœ¼ë¡œ ëŒ€ì²´ë¨) -->
<div id="modalContainer"></div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Summernote JS -->
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/lang/summernote-ko-KR.min.js"></script>

<!-- Enhanced Editor Plugins (ì„±ëŠ¥ ìµœì í™”: í•„ìˆ˜ í”ŒëŸ¬ê·¸ì¸ë§Œ ë¡œë“œ) -->
<script>
// í•µì‹¬ í”ŒëŸ¬ê·¸ì¸ë§Œ ë¹„ë™ê¸° ë¡œë“œ
const corePlugins = [
  '../../board_templates/js/summernote-plugins/core/plugin-loader.js',
  '../../board_templates/js/summernote-plugins/core/plugin-base.js',
  '../../board_templates/js/summernote-plugins/text-styles/strikethrough.js',
  '../../board_templates/js/summernote-plugins/text-styles/superscript.js',
  '../../board_templates/js/summernote-plugins/text-styles/subscript.js',
  '../../board_templates/js/summernote-plugins/paragraph/paragraph-styles.js?v=9.0',
  '../../board_templates/js/summernote-plugins/content/checklist.js?v=6.2',
  '../../board_templates/js/summernote-plugins/table/table-simple.js?v=6.2',
  '../../board_templates/js/summernote-plugins/special/blockquote.js?v=9.0'
];

// í”ŒëŸ¬ê·¸ì¸ ìˆœì°¨ì  ë¡œë“œ
let loadIndex = 0;
function loadNextPlugin() {
  if (loadIndex < corePlugins.length) {
    const script = document.createElement('script');
    script.src = corePlugins[loadIndex];
    script.onload = () => {
      loadIndex++;
      loadNextPlugin();
    };
    document.head.appendChild(script);
  }
}
// DOM ë¡œë“œ í›„ í”ŒëŸ¬ê·¸ì¸ ë¡œë“œ ì‹œì‘
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadNextPlugin);
} else {
  loadNextPlugin();
}
</script>

<!-- LinkPreviewClient (ì§€ì—° ë¡œë“œ) -->
<script>
setTimeout(() => {
  const script = document.createElement('script');
  script.src = '../../board_templates/LinkPreviewClient.js';
  document.head.appendChild(script);
}, 1000);
</script>
<script>
  $(document).ready(function() {
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²¨ë¶€íŒŒì¼ ì˜ì—­ ìƒíƒœ í™•ì¸
    
    // ì¸ë¨¸ë…¸íŠ¸ ì—ë””í„° ì´ˆê¸°í™” (ë©”ì¸ í˜ì´ì§€ì™€ ë™ì¼)
    $('#summernote').summernote({
      height: 400,
      minHeight: 200,
      maxHeight: 600,
      lang: 'ko-KR',
      placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...',
      styleTags: [
        'p', 'blockquote', 'pre', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'
      ],
      styleWithSpan: false,
      popover: {
        style: [
          ['style', ['style']]
        ]
      },
      toolbar: [
        // í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ê·¸ë£¹ (ë„¤ì´ë²„: ë³¸ë¬¸, ë‚˜ëˆ”ê³ ë”•, 15)
        ['textFormat', ['style', 'fontname', 'fontsize']],
        
        // í…ìŠ¤íŠ¸ íš¨ê³¼ ê·¸ë£¹ (ë„¤ì´ë²„: B, I, U, ì·¨ì†Œì„ , ìœ„ì²¨ì, ì•„ë˜ì²¨ì)
        ['textStyle', ['bold', 'italic', 'underline', 'strikethrough', 'superscript', 'subscript']],
        
        // ìƒ‰ìƒ ê·¸ë£¹ (ë„¤ì´ë²„: ê¸€ììƒ‰)
        ['color', ['forecolor', 'backcolor', 'highlighter']],
        
        // ì •ë ¬ ë° ëª©ë¡ ê·¸ë£¹ (ë„¤ì´ë²„: ì •ë ¬, ëª©ë¡)
        ['paragraph', ['ul', 'ol', 'paragraph', 'lineHeight']],
        
        // íŠ¹ìˆ˜ ìŠ¤íƒ€ì¼ ê·¸ë£¹ (ì¸ìš©êµ¬, ì½”ë“œ ë“±)
        ['special', ['blockquote', 'codeblock']],
        
        // ì½˜í…ì¸  ì‚½ì… ê·¸ë£¹ (ë„¤ì´ë²„: í‘œ, ì²¨ë¶€ ë“±)
        ['insert', ['table', 'checklist', 'divider', 'link', 'picture']],
        
        // ë·° ì»¨íŠ¸ë¡¤ ê·¸ë£¹
        ['view', ['fullscreen', 'codeview', 'clear', 'help']]
      ],
      callbacks: {
        // ì´ˆê¸°í™” ì™„ë£Œ í›„ ì¸ìš©êµ¬ ë‚´ë¶€ì—ì„œ ë‹¤ë¥¸ ê¸°ëŠ¥ ì‚¬ìš© ì‹œ ì™¸ë¶€ ì‚½ì… ì²˜ë¦¬
        onInit: function() {
          var $editable = $(this);
          
          // ì¸ìš©êµ¬ ë‚´ë¶€ í´ë¦­ ê°ì§€
          $editable.on('click', function(e) {
            var $target = $(e.target);
            var $quote = $target.closest('blockquote, .blockquote-bubble, .blockquote-quote, .blockquote-box');
            
            if ($quote.length > 0) {
              // ì¸ìš©êµ¬ ë‚´ë¶€ì— ìˆìŒì„ í‘œì‹œ
              $editable.data('inside-quote', $quote);
            } else {
              // ì¸ìš©êµ¬ ì™¸ë¶€
              $editable.removeData('inside-quote');
            }
          });
          
          // í‘œ ë²„íŠ¼ í´ë¦­ ì‹œ ì¸ìš©êµ¬ ì™¸ë¶€ì— ì‚½ì…
          setTimeout(function() {
            $('.note-toolbar .note-btn').on('click', function() {
              var $insideQuote = $editable.data('inside-quote');
              if ($insideQuote && $insideQuote.length > 0) {
                // ì¸ìš©êµ¬ ë‹¤ìŒì— ì»¤ì„œ ì´ë™
                var range = document.createRange();
                var selection = window.getSelection();
                
                // ì¸ìš©êµ¬ ë‹¤ìŒ ìœ„ì¹˜ì— ì„ì‹œ ìš”ì†Œ ì‚½ì…
                var $temp = $('<p><br></p>');
                $insideQuote.after($temp);
                
                // ì»¤ì„œë¥¼ ì„ì‹œ ìš”ì†Œë¡œ ì´ë™
                range.setStart($temp[0], 0);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
                
                // ì¸ìš©êµ¬ ë‚´ë¶€ ìƒíƒœ ì´ˆê¸°í™”
                $editable.removeData('inside-quote');
              }
            });
          }, 1000);
          
          // ìŠ¤íƒ€ì¼ ë“œë¡­ë‹¤ìš´ì—ì„œ ì¸ìš©êµ¬ ì œê±°
          setTimeout(function() {
            // Summernote ìŠ¤íƒ€ì¼ ì˜µì…˜ ì»¤ìŠ¤í„°ë§ˆì´ì§•
            var $styleDropdown = $('.note-toolbar .note-style .dropdown-menu');
            if ($styleDropdown.length > 0) {
              $styleDropdown.find('a[data-value="blockquote"]').remove();
              $styleDropdown.find('li:contains("Blockquote")').remove();
              $styleDropdown.find('li:contains("ì¸ìš©êµ¬")').remove();
            }
          }, 1500);
        },
        
        // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì½œë°±
        onImageUpload: function(files) {
          for (let i = 0; i < files.length; i++) {
            uploadImage(files[i], $(this));
          }
        }
      }
    });
    
    // Summernote ì´ˆê¸°í™” í›„ ê¸°ë³¸ í‘œ ë²„íŠ¼ ê¸°ëŠ¥ ìˆ˜ì •
    setTimeout(function() {
      const tableBtn = $('.note-toolbar .note-table .note-btn[data-original-title*="Table"], .note-toolbar .note-table .note-btn[title*="Table"], .note-toolbar .note-table .note-btn[data-original-title*="í‘œ"], .note-toolbar .note-table .note-btn[title*="í‘œ"]').first();
      
      if (tableBtn.length > 0) {
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±°
        tableBtn.off('click');
        
        // ìƒˆë¡œìš´ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ (ì¦‰ì‹œ 3x3 í…Œë‘ë¦¬ í‘œ ì‚½ì…)
        tableBtn.on('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const tableHtml = `
            <table style="border-collapse: collapse; width: 100%; margin: 10px 0; border: 1px solid #D1D5DB;">
              <tr>
                <th style="border: 1px solid #D1D5DB; padding: 8px; background-color: #FEF3C7; font-weight: 600;">í—¤ë” 1</th>
                <th style="border: 1px solid #D1D5DB; padding: 8px; background-color: #FEF3C7; font-weight: 600;">í—¤ë” 2</th>
                <th style="border: 1px solid #D1D5DB; padding: 8px; background-color: #FEF3C7; font-weight: 600;">í—¤ë” 3</th>
              </tr>
              <tr>
                <td style="border: 1px solid #D1D5DB; padding: 8px; min-width: 50px;">ë‚´ìš© 1-1</td>
                <td style="border: 1px solid #D1D5DB; padding: 8px; min-width: 50px;">ë‚´ìš© 1-2</td>
                <td style="border: 1px solid #D1D5DB; padding: 8px; min-width: 50px;">ë‚´ìš© 1-3</td>
              </tr>
              <tr>
                <td style="border: 1px solid #D1D5DB; padding: 8px; min-width: 50px;">ë‚´ìš© 2-1</td>
                <td style="border: 1px solid #D1D5DB; padding: 8px; min-width: 50px;">ë‚´ìš© 2-2</td>
                <td style="border: 1px solid #D1D5DB; padding: 8px; min-width: 50px;">ë‚´ìš© 2-3</td>
              </tr>
            </table>
            <p><br></p>
          `;
          $('#summernote').summernote('pasteHTML', tableHtml);
          
          return false;
        });
        
        // íˆ´íŒ ì—…ë°ì´íŠ¸
        tableBtn.attr('title', 'í‘œ ì‚½ì… (Ctrl+Shift+T)');
        tableBtn.attr('data-original-title', 'í‘œ ì‚½ì… (Ctrl+Shift+T)');
        
      } else {
      }
    }, 1000);
    
    
    // ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¨ìˆ˜ (ë©”ì¸ í˜ì´ì§€ì™€ ë™ì¼)
    function uploadImage(file, editor) {
      if (!file || !file.type.startsWith('image/')) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
      }
      
      if (file.size > 5 * 1024 * 1024) { // 5MB
        alert('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
      }
      
      const formData = new FormData();
      formData.append('image', file);
      
      // admin ê²½ë¡œì— ë§ëŠ” ì—…ë¡œë“œ URL ì‚¬ìš©
      $.ajax({
        url: 'upload_image.php',
        method: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        success: function(response) {
          try {
            if (typeof response === 'string') {
              response = JSON.parse(response);
            }
            
            if (response.success) {
              let imageUrl = response.url;
              
              // admin ìƒëŒ€ ê²½ë¡œ ì²˜ë¦¬
              if (response.urls && response.urls.admin_relative) {
                imageUrl = response.urls.admin_relative;
              } else if (imageUrl.startsWith('uploads/')) {
                imageUrl = '../../' + imageUrl;
              }
              
              editor.summernote('insertImage', imageUrl, function($image) {
                $image.css('max-width', '100%');
              });
            } else {
              alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + response.message);
            }
          } catch (e) {
            alert('ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
          }
        },
        error: function(xhr, status, error) {
          alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
        }
      });
    }
    
    // ì·¨ì†Œ ë²„íŠ¼
    $('#cancel-btn').click(function() {
      if (confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        window.location.href = 'list.php';
      }
    });
    
    // ê²Œì‹œíŒ ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸ ì§ì ‘ ì—°ê²°
    $('#board_id').on('change', function(e) {
      // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ì§€ ë° í¼ ì œì¶œ ë°©ì§€
      e.preventDefault();
      e.stopPropagation();
      
      const boardId = $(this).val();
      
      // ê²Œì‹œíŒ IDê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ AJAX ìš”ì²­ ì‹¤í–‰
      if (boardId) {
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²¨ë¶€íŒŒì¼ ì˜ì—­ ìƒíƒœ í™•ì¸
        
        $.ajax({
          url: 'get_board_info.php',
          type: 'GET',
          data: { board_id: boardId },
          dataType: 'json',
          success: function(response) {
            // write_level ê°’ ë³„ë„ ë¡œê·¸
            if (typeof response.write_level !== 'undefined') {
            } else {
            }
            
            // ì²¨ë¶€íŒŒì¼ í—ˆìš© ì—¬ë¶€ í™•ì¸ ë° ì²˜ë¦¬
            if (response.allow_attachments == 1) {
              $('#attachments_container').css('display', 'block');
              $('#allow_attachments').val('true');
            } else {
              $('#attachments_container').css('display', 'none');
              $('#allow_attachments').val('false');
            }
            
            // í˜ì´ìŠ¤ë¶ ì—…ë¡œë“œ ì²´í¬ë°•ìŠ¤ í‘œì‹œ ì—¬ë¶€ ì„¤ì •
            if (response.write_level == 0) {
              $('#facebook_post_container').show();
            } else {
              $('#facebook_post_container').hide();
              $('#post_to_facebook').prop('checked', false);
            }
            
            // ì¹´í…Œê³ ë¦¬ ì²˜ë¦¬
            loadCategories(boardId);
          },
          error: function(xhr, status, error) {
            console.error('ê²Œì‹œíŒ ì •ë³´ ë¡œë”© ì‹¤íŒ¨:', error);
            alert('ê²Œì‹œíŒ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
          }
        });
      } else {
        // ê²Œì‹œíŒ ì„ íƒì´ ì—†ëŠ” ê²½ìš° ì²¨ë¶€íŒŒì¼ ì˜ì—­ ìˆ¨ê¹€
        $('#attachments_container').css('display', 'none');
        $('#allow_attachments').val('false');
        $('#category_container').addClass('d-none');
        $('#facebook_post_container').hide();
        $('#post_to_facebook').prop('checked', false);
      }
      
      return false;
    });
    
    // ê²Œì‹œíŒ ë³€ê²½ ì‹œ ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¡œë“œ
    function loadCategories(boardId) {
      if (!boardId) {
        $('#category_container').addClass('d-none');
        return;
      }
      
      $.ajax({
        url: 'get_categories.php',
        type: 'GET',
        data: { board_id: boardId },
        dataType: 'json',
        success: function(response) {
          
          if (response.use_category && response.categories && response.categories.length > 0) {
            // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì—…ë°ì´íŠ¸
            var categorySelect = $('#category_id');
            categorySelect.empty();
            categorySelect.append('<option value="">-- ì¹´í…Œê³ ë¦¬ ì„ íƒ --</option>');
            
            $.each(response.categories, function(index, category) {
              categorySelect.append('<option value="' + category.id + '">' + category.name + '</option>');
            });
            
            $('#category_container').removeClass('d-none');
          } else {
            $('#category_container').addClass('d-none');
          }
        },
        error: function(xhr, status, error) {
          console.error('ì¹´í…Œê³ ë¦¬ ë¡œë”© ì‹¤íŒ¨:', error);
          console.error('ìƒíƒœ:', status);
          console.error('ì‘ë‹µ:', xhr.responseText);
          $('#category_container').addClass('d-none');
        }
      });
    }
    
  });
</script>
</body>
</html> 