<?php
// /admin/settings/site_settings.php - Admin ÎèÖÎ¶Ω Î≤ÑÏ†Ñ
require __DIR__ . '/../bootstrap.php';
require __DIR__ . '/../templates_bridge.php';
require_once __DIR__ . '/../../includes/config_helpers.php';

// Include theme functions
if (file_exists(__DIR__ . '/../../includes/theme_functions.php')) {
    require_once __DIR__ . '/../../includes/theme_functions.php';
}

// Admin Ï†ÑÏö© ÌÖåÎßà Ìï®ÏàòÎì§ (Ï§ëÎ≥µ Î∞©ÏßÄ)
if (!function_exists('saveThemeCSS')) {
    function saveThemeCSS($settings) {
    $css_content = "
:root {
    --primary: {$settings['primary_color']};
    --secondary: {$settings['secondary_color']};
    --success: {$settings['success_color']};
    --info: {$settings['info_color']};
    --warning: {$settings['warning_color']};
    --danger: {$settings['danger_color']};
    --light: {$settings['light_color']};
    --dark: {$settings['dark_color']};
    --body-font: {$settings['body_font']};
    --heading-font: {$settings['heading_font']};
    --font-size-base: {$settings['font_size_base']};
}
";
    
    $css_file = __DIR__ . '/../../css/theme-dynamic.css';
    $css_dir = dirname($css_file);
    
    if (!is_dir($css_dir)) {
        mkdir($css_dir, 0755, true);
    }
    
    return file_put_contents($css_file, $css_content) !== false;
    }
}

if (!function_exists('saveCustomTheme')) {
    function saveCustomTheme($pdo, $theme_name, $theme_data) {
    try {
        $stmt = $pdo->prepare("
            INSERT INTO " . get_table_name('custom_themes') . " (theme_name, theme_data, created_at) 
            VALUES (?, ?, NOW())
            ON DUPLICATE KEY UPDATE 
            theme_data = VALUES(theme_data), 
            updated_at = NOW()
        ");
        
        return $stmt->execute([$theme_name, json_encode($theme_data)]);
    } catch (PDOException $e) {
        error_log("Ïª§Ïä§ÌÖÄ ÌÖåÎßà Ï†ÄÏû• Ïò§Î•ò: " . $e->getMessage());
        return false;
    }
    }
}

if (!function_exists('getDefaultThemes')) {
    function getDefaultThemes() {
    return [
        'default' => [
            'name' => 'Í∏∞Î≥∏ ÌÖåÎßà',
            'description' => 'Í∏∞Î≥∏ Bootstrap ÌÖåÎßà',
            'settings' => [
                'primary_color' => '#0d6efd',
                'secondary_color' => '#6c757d',
                'success_color' => '#198754',
                'info_color' => '#0dcaf0',
                'warning_color' => '#ffc107',
                'danger_color' => '#dc3545',
                'light_color' => '#f8f9fa',
                'dark_color' => '#212529'
            ]
        ],
        'corporate' => [
            'name' => 'Í∏∞ÏóÖÌòï',
            'description' => 'Í∏∞ÏóÖÏö© ÌÖåÎßà',
            'settings' => [
                'primary_color' => '#2c3e50',
                'secondary_color' => '#95a5a6',
                'success_color' => '#27ae60',
                'info_color' => '#3498db',
                'warning_color' => '#f39c12',
                'danger_color' => '#e74c3c',
                'light_color' => '#ecf0f1',
                'dark_color' => '#2c3e50'
            ]
        ]
    ];
}

if (!function_exists('getCurrentThemeId')) {
    function getCurrentThemeId($pdo) {
        try {
            $stmt = $pdo->prepare("SELECT setting_value FROM " . get_table_name('site_settings') . " WHERE setting_key = 'current_theme'");
            $stmt->execute();
            $result = $stmt->fetchColumn();
            return $result ?: 'default';
        } catch (PDOException $e) {
            return 'default';
        }
    }
}

if (!function_exists('applyThemePreset')) {
    function applyThemePreset($pdo, $theme_id) {
        try {
            $themes = getDefaultThemes();
            if (!isset($themes[$theme_id])) {
                return false;
            }
            
            $theme_settings = $themes[$theme_id]['settings'];
            $pdo->beginTransaction();
            
            // ÌÖåÎßà ÏÑ§Ï†ï Ï†ÅÏö©
            $stmt = $pdo->prepare("UPDATE " . get_table_name('site_settings') . " SET setting_value = ? WHERE setting_key = ?");
            foreach ($theme_settings as $key => $value) {
                $stmt->execute([$value, $key]);
            }
            
            // ÌòÑÏû¨ ÌÖåÎßà ID Ï†ÄÏû•
            $stmt->execute([$theme_id, 'current_theme']);
            
            // CSS ÌååÏùº ÏÉùÏÑ±
            $updated_settings = getSiteSettings($pdo);
            saveThemeCSS($updated_settings);
            
            $pdo->commit();
            return true;
        } catch (Exception $e) {
            $pdo->rollback();
            error_log("ÌÖåÎßà Ï†ÅÏö© Ïò§Î•ò: " . $e->getMessage());
            return false;
        }
    }
}
}

// ÌÖåÏù¥Î∏îÏù¥ ÏóÜÎäî Í≤ΩÏö∞ ÏÉùÏÑ±
try {
  $pdo->query("SELECT 1 FROM " . get_table_name('site_settings') . " LIMIT 1");
} catch (PDOException $e) {
  // ÌÖåÏù¥Î∏î ÏÉùÏÑ± ÏΩîÎìú (ÏõêÎ≥∏Í≥º ÎèôÏùº)
  $sql = "CREATE TABLE " . get_table_name('site_settings') . " (
    id INT(11) NOT NULL AUTO_INCREMENT,
    setting_key VARCHAR(100) NOT NULL COMMENT 'ÏÑ§Ï†ï ÌÇ§',
    setting_value TEXT COMMENT 'ÏÑ§Ï†ï Í∞í',
    setting_group VARCHAR(50) NOT NULL DEFAULT 'general' COMMENT 'ÏÑ§Ï†ï Í∑∏Î£π',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'ÏÉùÏÑ± ÏùºÏãú',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'ÏàòÏ†ï ÏùºÏãú',
    PRIMARY KEY (id),
    UNIQUE KEY setting_key (setting_key)
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci";
  
  $pdo->exec($sql);
  
  // Í∏∞Î≥∏ ÏÑ§Ï†ïÍ∞í Ï∂îÍ∞Ä
  $default_settings = [
    ['site_name', 'Ìù¨ÎßùÏî®', 'general'],
    ['site_description', 'ÎÖ∏ÎèôÍ∂å Ï∞æÍ∏∞Î•º ÏúÑÌïú Ï†ïÎ≥¥ÏôÄ ÏßÄÏõê', 'general'],
    ['site_logo', '', 'general'],
    ['site_favicon', '', 'general'],
    ['admin_email', 'admin@example.com', 'general'],
    ['primary_color', '#0d6efd', 'theme'],
    ['secondary_color', '#6c757d', 'theme'],
    ['success_color', '#198754', 'theme'],
    ['info_color', '#0dcaf0', 'theme'],
    ['warning_color', '#ffc107', 'theme'],
    ['danger_color', '#dc3545', 'theme'],
    ['light_color', '#f8f9fa', 'theme'],
    ['dark_color', '#212529', 'theme'],
    ['body_font', "'Segoe UI', sans-serif", 'font'],
    ['heading_font', "'Segoe UI', sans-serif", 'font'],
    ['font_size_base', '1rem', 'font'],
    ['navbar_layout', 'fixed-top', 'layout'],
    ['sidebar_layout', 'left', 'layout'],
    ['footer_layout', 'standard', 'layout'],
    ['container_width', 'standard', 'layout'],
    ['facebook_url', '', 'social'],
    ['twitter_url', '', 'social'],
    ['instagram_url', '', 'social'],
    ['youtube_url', '', 'social'],
    ['kakaotalk_url', '', 'social'],
    ['google_analytics_id', '', 'other'],
    ['custom_css', '', 'other'],
    ['custom_js', '', 'other']
  ];
  
  $sql = "INSERT INTO " . get_table_name('site_settings') . " (setting_key, setting_value, setting_group) VALUES (?, ?, ?)";
  $stmt = $pdo->prepare($sql);
  
  foreach ($default_settings as $setting) {
    $stmt->execute($setting);
  }
}

// Î™®Îì† ÏÑ§Ï†ï Í∞ÄÏ†∏Ïò§Í∏∞
$all_settings = getSiteSettings($pdo);

// ÏÑ§Ï†ï Ï†ÄÏû• Ï≤òÎ¶¨
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  try {
    // ÌÖåÎßà ÌîÑÎ¶¨ÏÖã Ï†ÅÏö© Ï≤òÎ¶¨ (Ìä∏ÎûúÏû≠ÏÖòÏùÄ Ìï®Ïàò ÎÇ¥Î∂ÄÏóêÏÑú Ï≤òÎ¶¨)
    if (isset($_POST['apply_theme_preset'])) {
      $theme_id = $_POST['theme_preset'] ?? '';
      
      error_log("ÌÖåÎßà Ï†ÅÏö© ÏãúÎèÑ: " . $theme_id);
      
      if (applyThemePreset($pdo, $theme_id)) {
        $_SESSION['success_message'] = 'ÌÖåÎßà ÌîÑÎ¶¨ÏÖãÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§.';
        
        // ÏÑ§Ï†ïÍ∞íÏùÑ ÏÉàÎ°ú Í∞ÄÏ†∏ÏôÄÏÑú CSS ÌååÏùºÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
        $theme_settings = getSiteSettings($pdo);
        saveThemeCSS($theme_settings);
        
        // POST-Redirect-GET Ìå®ÌÑ¥ÏúºÎ°ú Ï†ÅÏ†àÌïú Î¶¨Îã§Ïù¥Î†âÌä∏
        header("Location: " . $_SERVER['PHP_SELF'] . "?tab=theme&applied=1");
        exit;
      } else {
        throw new Exception('ÌÖåÎßà ÌîÑÎ¶¨ÏÖã Ï†ÅÏö©Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    }
    
    // Ïª§Ïä§ÌÖÄ ÌÖåÎßà Ï†ÄÏû• Ï≤òÎ¶¨
    if (isset($_POST['save_custom_theme'])) {
      $pdo->beginTransaction();
      
      $theme_name = trim($_POST['custom_theme_name'] ?? '');
      
      if (empty($theme_name)) {
        throw new Exception('ÌÖåÎßà Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
      }
      
      // ÌòÑÏû¨ ÏÑ§Ï†ïÍ∞íÏùÑ Ïª§Ïä§ÌÖÄ ÌÖåÎßàÎ°ú Ï†ÄÏû•
      $current_settings = getSiteSettings($pdo);
      
      $theme_data = [
        'name' => $theme_name,
        'description' => trim($_POST['custom_theme_description'] ?? ''),
        'created_at' => date('Y-m-d H:i:s'),
        'settings' => []
      ];
      
      // ÌÖåÎßà Í¥ÄÎ†® ÏÑ§Ï†ïÎßå Ï∂îÏ∂ú
      $theme_keys = [
        'primary_color', 'secondary_color', 'success_color', 'info_color',
        'warning_color', 'danger_color', 'light_color', 'dark_color',
        'body_font', 'heading_font', 'font_size_base',
        'navbar_layout', 'sidebar_layout', 'footer_layout', 'container_width'
      ];
      
      foreach ($theme_keys as $key) {
        if (isset($current_settings[$key])) {
          $theme_data['settings'][$key] = $current_settings[$key];
        }
      }
      
      $saved_key = saveCustomTheme($pdo, $theme_name, $theme_data);
      
      if ($saved_key) {
        $_SESSION['success_message'] = 'Ïª§Ïä§ÌÖÄ ÌÖåÎßà "' . htmlspecialchars($theme_name) . '"Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.';
        $pdo->commit();
        
        header("Location: " . $_SERVER['PHP_SELF'] . "?tab=theme&saved=1");
        exit;
      } else {
        throw new Exception('Ïª§Ïä§ÌÖÄ ÌÖåÎßà Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    }
    
    // Í∞Å ÏÑ§Ï†ï Í∑∏Î£πÎ≥Ñ Ï†ÄÏû• Ï≤òÎ¶¨
    if (isset($_POST['save_general'])) {
      $pdo->beginTransaction();
      
      $general_settings = [
        'site_name' => trim($_POST['site_name'] ?? ''),
        'site_description' => trim($_POST['site_description'] ?? ''),
        'admin_email' => trim($_POST['admin_email'] ?? '')
      ];
      
      $stmt = $pdo->prepare("UPDATE " . get_table_name('site_settings') . " SET setting_value = ? WHERE setting_key = ?");
      foreach ($general_settings as $key => $value) {
        $stmt->execute([$value, $key]);
      }
      
      $pdo->commit();
      $_SESSION['success_message'] = 'ÏùºÎ∞ò ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.';
      
      header("Location: " . $_SERVER['PHP_SELF'] . "?tab=general&saved=1");
      exit;
    }
    
    if (isset($_POST['save_theme'])) {
      $pdo->beginTransaction();
      
      $theme_settings = [
        'primary_color' => trim($_POST['primary_color'] ?? '#0d6efd'),
        'secondary_color' => trim($_POST['secondary_color'] ?? '#6c757d'),
        'success_color' => trim($_POST['success_color'] ?? '#198754'),
        'info_color' => trim($_POST['info_color'] ?? '#0dcaf0'),
        'warning_color' => trim($_POST['warning_color'] ?? '#ffc107'),
        'danger_color' => trim($_POST['danger_color'] ?? '#dc3545'),
        'light_color' => trim($_POST['light_color'] ?? '#f8f9fa'),
        'dark_color' => trim($_POST['dark_color'] ?? '#212529')
      ];
      
      $stmt = $pdo->prepare("UPDATE " . get_table_name('site_settings') . " SET setting_value = ? WHERE setting_key = ?");
      foreach ($theme_settings as $key => $value) {
        $stmt->execute([$value, $key]);
      }
      
      // ÏàòÎèô ÌÖåÎßà Ï†ÅÏö© ÌõÑ CSS ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏
      $updated_settings = getSiteSettings($pdo);
      saveThemeCSS($updated_settings);
      
      $pdo->commit();
      $_SESSION['success_message'] = 'ÌÖåÎßà ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.';
      
      header("Location: " . $_SERVER['PHP_SELF'] . "?tab=theme&saved=1");
      exit;
    }
    
    if (isset($_POST['save_font'])) {
      $pdo->beginTransaction();
      
      $font_settings = [
        'body_font' => trim($_POST['body_font'] ?? "'Segoe UI', sans-serif"),
        'heading_font' => trim($_POST['heading_font'] ?? "'Segoe UI', sans-serif"),
        'font_size_base' => trim($_POST['font_size_base'] ?? '1rem')
      ];
      
      $stmt = $pdo->prepare("UPDATE " . get_table_name('site_settings') . " SET setting_value = ? WHERE setting_key = ?");
      foreach ($font_settings as $key => $value) {
        $stmt->execute([$value, $key]);
      }
      
      $pdo->commit();
      $_SESSION['success_message'] = 'Ìè∞Ìä∏ ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.';
      
      header("Location: " . $_SERVER['PHP_SELF'] . "?tab=font&saved=1");
      exit;
    }
    
    if (isset($_POST['save_layout'])) {
      $pdo->beginTransaction();
      
      $layout_settings = [
        'navbar_layout' => trim($_POST['navbar_layout'] ?? 'fixed-top'),
        'sidebar_layout' => trim($_POST['sidebar_layout'] ?? 'left'),
        'footer_layout' => trim($_POST['footer_layout'] ?? 'standard'),
        'container_width' => trim($_POST['container_width'] ?? 'standard')
      ];
      
      $stmt = $pdo->prepare("UPDATE " . get_table_name('site_settings') . " SET setting_value = ? WHERE setting_key = ?");
      foreach ($layout_settings as $key => $value) {
        $stmt->execute([$value, $key]);
      }
      
      $pdo->commit();
      $_SESSION['success_message'] = 'Î†àÏù¥ÏïÑÏõÉ ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.';
      
      header("Location: " . $_SERVER['PHP_SELF'] . "?tab=layout&saved=1");
      exit;
    }
    
    if (isset($_POST['save_social'])) {
      $pdo->beginTransaction();
      
      $social_settings = [
        'facebook_url' => trim($_POST['facebook_url'] ?? ''),
        'twitter_url' => trim($_POST['twitter_url'] ?? ''),
        'instagram_url' => trim($_POST['instagram_url'] ?? ''),
        'youtube_url' => trim($_POST['youtube_url'] ?? ''),
        'kakaotalk_url' => trim($_POST['kakaotalk_url'] ?? '')
      ];
      
      $stmt = $pdo->prepare("UPDATE " . get_table_name('site_settings') . " SET setting_value = ? WHERE setting_key = ?");
      foreach ($social_settings as $key => $value) {
        $stmt->execute([$value, $key]);
      }
      
      $pdo->commit();
      $_SESSION['success_message'] = 'SNS ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.';
      
      header("Location: " . $_SERVER['PHP_SELF'] . "?tab=social&saved=1");
      exit;
    }
    
    if (isset($_POST['save_other'])) {
      $pdo->beginTransaction();
      
      $other_settings = [
        'google_analytics_id' => trim($_POST['google_analytics_id'] ?? ''),
        'custom_css' => trim($_POST['custom_css'] ?? ''),
        'custom_js' => trim($_POST['custom_js'] ?? '')
      ];
      
      $stmt = $pdo->prepare("UPDATE " . get_table_name('site_settings') . " SET setting_value = ? WHERE setting_key = ?");
      foreach ($other_settings as $key => $value) {
        $stmt->execute([$value, $key]);
      }
      
      $pdo->commit();
      $_SESSION['success_message'] = 'Í∏∞ÌÉÄ ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.';
      
      header("Location: " . $_SERVER['PHP_SELF'] . "?tab=other&saved=1");
      exit;
    }
    
  } catch (Exception $e) {
    if ($pdo->inTransaction()) {
      $pdo->rollBack();
    }
    $_SESSION['error_message'] = 'ÏÑ§Ï†ï Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' . $e->getMessage();
    error_log("ÌÖåÎßà ÏÑ§Ï†ï Ïò§Î•ò: " . $e->getMessage());
    
    // Ïò§Î•ò Î∞úÏÉù ÏãúÏóêÎèÑ Ï†ÅÏ†àÌïú ÌÉ≠ÏúºÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏
    $tab = 'general';
    if (isset($_POST['apply_theme_preset']) || isset($_POST['save_custom_theme']) || isset($_POST['save_theme'])) {
      $tab = 'theme';
    } elseif (isset($_POST['save_font'])) {
      $tab = 'font';
    } elseif (isset($_POST['save_layout'])) {
      $tab = 'layout';
    } elseif (isset($_POST['save_social'])) {
      $tab = 'social';
    } elseif (isset($_POST['save_other'])) {
      $tab = 'other';
    }
    
    header("Location: " . $_SERVER['PHP_SELF'] . "?tab=" . $tab . "&error=1");
    exit;
  } catch (PDOException $e) {
    if ($pdo->inTransaction()) {
      $pdo->rollBack();
    }
    $_SESSION['error_message'] = 'Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' . $e->getMessage();
    error_log("Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïò§Î•ò: " . $e->getMessage());
    
    header("Location: " . $_SERVER['PHP_SELF'] . "?tab=general&error=1");
    exit;
  }
}

// POST Ï≤òÎ¶¨Í∞Ä Î™®Îëê ÏôÑÎ£åÎêú ÌõÑÏóêÎßå ÏÑ§Ï†ïÏùÑ Îã§Ïãú Í∞ÄÏ†∏Ïò¥
$all_settings = getSiteSettings($pdo);

// ÌòÑÏû¨ ÌôúÏÑ±ÌôîÎêú ÌÉ≠
$active_tab = isset($_GET['tab']) ? $_GET['tab'] : 'general';

// ÌÖúÌîåÎ¶ø Î≥ÄÏàò ÏÑ§Ï†ï
$page_title = 'ÎîîÏûêÏù∏ ÏÑ§Ï†ï';
$active_menu = 'settings';
$breadcrumb = [
    ['title' => 'ÎåÄÏãúÎ≥¥Îìú', 'url' => '/admin/index.php'],
    ['title' => 'ÎîîÏûêÏù∏ ÏÑ§Ï†ï']
];

$additional_css = [
    'https://cdn.jsdelivr.net/npm/codemirror@5.65.3/lib/codemirror.min.css',
    'https://cdn.jsdelivr.net/npm/codemirror@5.65.3/theme/dracula.min.css'
];

$additional_js = [
    'https://code.jquery.com/jquery-3.6.0.min.js',
    'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js',
    'https://cdn.jsdelivr.net/npm/codemirror@5.65.3/lib/codemirror.min.js',
    'https://cdn.jsdelivr.net/npm/codemirror@5.65.3/mode/css/css.min.js',
    'https://cdn.jsdelivr.net/npm/codemirror@5.65.3/mode/javascript/javascript.min.js'
];

// Î©îÏù∏ ÏΩòÌÖêÏ∏† ÏÉùÏÑ±
ob_start();
?>
<!-- ÌéòÏù¥ÏßÄ Ìó§Îçî -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üé® ÎîîÏûêÏù∏ ÏÑ§Ï†ï</h2>
</div>

<!-- ÌÉ≠ Î©îÎâ¥ -->
<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <a class="nav-link <?= $active_tab === 'general' ? 'active' : '' ?>" href="?tab=general">ÏùºÎ∞ò ÏÑ§Ï†ï</a>
    </li>
    <li class="nav-item">
        <a class="nav-link <?= $active_tab === 'theme' ? 'active' : '' ?>" href="?tab=theme">ÌÖåÎßà ÏÑ§Ï†ï</a>
    </li>
    <li class="nav-item">
        <a class="nav-link <?= $active_tab === 'font' ? 'active' : '' ?>" href="?tab=font">Ìè∞Ìä∏ ÏÑ§Ï†ï</a>
    </li>
    <li class="nav-item">
        <a class="nav-link <?= $active_tab === 'layout' ? 'active' : '' ?>" href="?tab=layout">Î†àÏù¥ÏïÑÏõÉ ÏÑ§Ï†ï</a>
    </li>
    <li class="nav-item">
        <a class="nav-link <?= $active_tab === 'social' ? 'active' : '' ?>" href="?tab=social">SNS ÏÑ§Ï†ï</a>
    </li>
    <li class="nav-item">
        <a class="nav-link <?= $active_tab === 'other' ? 'active' : '' ?>" href="?tab=other">Í∏∞ÌÉÄ ÏÑ§Ï†ï</a>
    </li>
</ul>

<!-- Î©îÏãúÏßÄ ÌëúÏãú ÏòÅÏó≠ -->
<?php if (isset($_SESSION['success_message'])): ?>
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle"></i>
    <?= htmlspecialchars($_SESSION['success_message']) ?>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
<?php unset($_SESSION['success_message']); endif; ?>

<?php if (isset($_SESSION['error_message'])): ?>
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle"></i>
    <?= htmlspecialchars($_SESSION['error_message']) ?>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
<?php unset($_SESSION['error_message']); endif; ?>

<?php if (isset($_GET['applied']) && $_GET['applied'] == '1'): ?>
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-palette-fill"></i>
    ÌÖåÎßàÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§! Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÑ ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
<?php endif; ?>

<!-- ÏùºÎ∞ò ÏÑ§Ï†ï ÌÉ≠ -->
<div class="tab-content">
    <div class="tab-pane fade <?= $active_tab === 'general' ? 'show active' : '' ?>" id="general">
        <div class="card">
            <div class="card-body">
                <form action="site_settings.php?tab=general" method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="site_name" class="form-label">ÏÇ¨Ïù¥Ìä∏ Ïù¥Î¶Ñ</label>
                        <input type="text" class="form-control" id="site_name" name="site_name" value="<?= htmlspecialchars($all_settings['site_name'] ?? '') ?>">
                        <small class="form-text text-muted">ÏõπÏÇ¨Ïù¥Ìä∏Ïùò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="site_description" class="form-label">ÏÇ¨Ïù¥Ìä∏ ÏÑ§Î™Ö</label>
                        <textarea class="form-control" id="site_description" name="site_description" rows="2"><?= htmlspecialchars($all_settings['site_description'] ?? '') ?></textarea>
                        <small class="form-text text-muted">ÏõπÏÇ¨Ïù¥Ìä∏Ïóê ÎåÄÌïú Í∞ÑÎûµÌïú ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="admin_email" class="form-label">Í¥ÄÎ¶¨Ïûê Ïù¥Î©îÏùº</label>
                        <input type="email" class="form-control" id="admin_email" name="admin_email" value="<?= htmlspecialchars($all_settings['admin_email'] ?? '') ?>">
                        <small class="form-text text-muted">ÏÇ¨Ïù¥Ìä∏ Í¥ÄÎ¶¨ÏûêÏùò Ïù¥Î©îÏùº Ï£ºÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</small>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="submit" name="save_general" class="btn btn-primary">
                            <i class="bi bi-save"></i> Ï†ÄÏû•
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ÌÖåÎßà ÏÑ§Ï†ï ÌÉ≠ -->
    <div class="tab-pane fade <?= $active_tab === 'theme' ? 'show active' : '' ?>" id="theme">
        
        <!-- ÌÖåÎßà ÌîÑÎ¶¨ÏÖã ÏÑπÏÖò -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-palette-fill"></i> ÌÖåÎßà ÌîÑÎ¶¨ÏÖã
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">ÎØ∏Î¶¨ Ï§ÄÎπÑÎêú ÌÖåÎßàÎ•º ÏÑ†ÌÉùÌïòÏó¨ Îπ†Î•¥Í≤å Ï†ÅÏö©ÌïòÏÑ∏Ïöî.</p>
                
                <form action="site_settings.php?tab=theme" method="POST" class="mb-4">
                    <div class="row">
                        <?php 
                        $themes = getDefaultThemes();
                        $current_theme_id = getCurrentThemeId($pdo);
                        foreach ($themes as $theme_id => $theme_data): 
                        ?>
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100 theme-preview-card <?= $current_theme_id === $theme_id ? 'border-primary' : '' ?>">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <input type="radio" name="theme_preset" value="<?= $theme_id ?>" 
                                               id="theme_<?= $theme_id ?>" class="form-check-input me-2"
                                               <?= $current_theme_id === $theme_id ? 'checked' : '' ?>>
                                        <label for="theme_<?= $theme_id ?>" class="form-check-label fw-bold">
                                            <?= htmlspecialchars($theme_data['name']) ?>
                                        </label>
                                        <?php if ($current_theme_id === $theme_id): ?>
                                        <span class="badge bg-primary ms-auto">ÌòÑÏû¨ Ï†ÅÏö©</span>
                                        <?php endif; ?>
                                    </div>
                                    <p class="text-muted small mb-3"><?= htmlspecialchars($theme_data['description']) ?></p>
                                    
                                    <!-- ÏÉâÏÉÅ ÎØ∏Î¶¨Î≥¥Í∏∞ -->
                                    <div class="theme-color-preview mb-2">
                                        <small class="text-muted d-block mb-1">ÏÉâÏÉÅ ÎØ∏Î¶¨Î≥¥Í∏∞</small>
                                        <div class="d-flex gap-1">
                                            <div class="color-sample" style="background-color: <?= $theme_data['settings']['primary_color'] ?>" title="Primary"></div>
                                            <div class="color-sample" style="background-color: <?= $theme_data['settings']['success_color'] ?>" title="Success"></div>
                                            <div class="color-sample" style="background-color: <?= $theme_data['settings']['info_color'] ?>" title="Info"></div>
                                            <div class="color-sample" style="background-color: <?= $theme_data['settings']['warning_color'] ?>" title="Warning"></div>
                                            <div class="color-sample" style="background-color: <?= $theme_data['settings']['danger_color'] ?>" title="Danger"></div>
                                        </div>
                                    </div>
                                    
                                    <small class="text-muted">
                                        Ìè∞Ìä∏: <?= htmlspecialchars(str_replace(["'", '"'], '', $theme_data['settings']['body_font'])) ?>
                                    </small>
                                </div>
                            </div>
                        </div>
                        <?php endforeach; ?>
                        
                        <!-- Ïª§Ïä§ÌÖÄ ÌÖåÎßàÎì§ -->
                        <?php 
                        $custom_themes = getCustomThemes($pdo);
                        foreach ($custom_themes as $theme_key => $theme_data): 
                        ?>
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100 theme-preview-card border-info <?= $current_theme_id === $theme_key ? 'border-primary' : '' ?>">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <input type="radio" name="theme_preset" value="<?= $theme_key ?>" 
                                               id="theme_<?= $theme_key ?>" class="form-check-input me-2"
                                               <?= $current_theme_id === $theme_key ? 'checked' : '' ?>>
                                        <label for="theme_<?= $theme_key ?>" class="form-check-label fw-bold">
                                            <i class="bi bi-star-fill text-warning"></i>
                                            <?= htmlspecialchars($theme_data['name']) ?>
                                        </label>
                                        <?php if ($current_theme_id === $theme_key): ?>
                                        <span class="badge bg-primary ms-auto">ÌòÑÏû¨ Ï†ÅÏö©</span>
                                        <?php endif; ?>
                                    </div>
                                    <p class="text-muted small mb-3"><?= htmlspecialchars($theme_data['description'] ?? 'Ïª§Ïä§ÌÖÄ ÌÖåÎßà') ?></p>
                                    
                                    <div class="theme-color-preview mb-2">
                                        <small class="text-muted d-block mb-1">ÏÉâÏÉÅ ÎØ∏Î¶¨Î≥¥Í∏∞</small>
                                        <div class="d-flex gap-1">
                                            <div class="color-sample" style="background-color: <?= $theme_data['settings']['primary_color'] ?>" title="Primary"></div>
                                            <div class="color-sample" style="background-color: <?= $theme_data['settings']['success_color'] ?>" title="Success"></div>
                                            <div class="color-sample" style="background-color: <?= $theme_data['settings']['info_color'] ?>" title="Info"></div>
                                            <div class="color-sample" style="background-color: <?= $theme_data['settings']['warning_color'] ?>" title="Warning"></div>
                                            <div class="color-sample" style="background-color: <?= $theme_data['settings']['danger_color'] ?>" title="Danger"></div>
                                        </div>
                                    </div>
                                    
                                    <small class="text-muted">
                                        ÏÉùÏÑ±Ïùº: <?= isset($theme_data['created_at']) ? date('Y-m-d', strtotime($theme_data['created_at'])) : 'Ïïå Ïàò ÏóÜÏùå' ?>
                                    </small>
                                </div>
                            </div>
                        </div>
                        <?php endforeach; ?>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <button type="button" class="btn btn-info me-2" onclick="previewSelectedTheme()">
                                <i class="bi bi-eye"></i> ÎØ∏Î¶¨Î≥¥Í∏∞
                            </button>
                            <button type="button" class="btn btn-secondary me-2" data-bs-toggle="modal" data-bs-target="#backupModal">
                                <i class="bi bi-clock-history"></i> Î∞±ÏóÖ Í¥ÄÎ¶¨
                            </button>
                        </div>
                        <div>
                            <button type="submit" name="apply_theme_preset" class="btn btn-success">
                                <i class="bi bi-check-circle"></i> ÏÑ†ÌÉùÌïú ÌÖåÎßà Ï†ÅÏö©
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- ÌòÑÏû¨ ÌÖåÎßàÎ•º Ïª§Ïä§ÌÖÄ ÌÖåÎßàÎ°ú Ï†ÄÏû• -->
                <div class="border-top pt-3">
                    <h6>ÌòÑÏû¨ ÏÑ§Ï†ïÏùÑ Ïª§Ïä§ÌÖÄ ÌÖåÎßàÎ°ú Ï†ÄÏû•</h6>
                    <form action="site_settings.php?tab=theme" method="POST">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="custom_theme_name" class="form-label">ÌÖåÎßà Ïù¥Î¶Ñ *</label>
                                    <input type="text" class="form-control" id="custom_theme_name" name="custom_theme_name" 
                                           placeholder="Ïòà: ÎÇ¥Í∞Ä ÎßåÎì† ÌÖåÎßà" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="custom_theme_description" class="form-label">ÏÑ§Î™Ö (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                                    <input type="text" class="form-control" id="custom_theme_description" name="custom_theme_description" 
                                           placeholder="ÌÖåÎßàÏóê ÎåÄÌïú Í∞ÑÎã®Ìïú ÏÑ§Î™Ö">
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="submit" name="save_custom_theme" class="btn btn-info">
                                <i class="bi bi-save"></i> Ïª§Ïä§ÌÖÄ ÌÖåÎßàÎ°ú Ï†ÄÏû•
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- ÏàòÎèô ÌÖåÎßà ÏÑ§Ï†ï ÏÑπÏÖò -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-sliders"></i> ÏàòÎèô ÌÖåÎßà ÏÑ§Ï†ï
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">ÏÉâÏÉÅÍ≥º Ìè∞Ìä∏Î•º ÏßÅÏ†ë Ï°∞Ï†ïÌïòÏó¨ ÌÖåÎßàÎ•º Ïª§Ïä§ÌÑ∞ÎßàÏù¥ÏßïÌïòÏÑ∏Ïöî.</p>
                
                <form action="site_settings.php?tab=theme" method="POST">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="primary_color" class="form-label">Ï£º ÏÉâÏÉÅ</label>
                                <div class="input-group">
                                    <span class="input-group-text p-1">
                                        <div class="color-preview" 
                                             style="width: 35px; height: 35px; background-color: <?= htmlspecialchars($all_settings['primary_color'] ?? '#0d6efd') ?>; border-radius: 4px; border: 2px solid #dee2e6; cursor: pointer;"
                                             data-color-target="primary_color"></div>
                                    </span>
                                    <input type="color" class="form-control color-picker" 
                                           id="primary_color" name="primary_color" 
                                           value="<?= htmlspecialchars($all_settings['primary_color'] ?? '#0d6efd') ?>"
                                           style="width: 60px;">
                                    <input type="text" class="form-control color-text" 
                                           value="<?= htmlspecialchars($all_settings['primary_color'] ?? '#0d6efd') ?>"
                                           data-color-input="primary_color"
                                           placeholder="#0d6efd">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="secondary_color" class="form-label">Î≥¥Ï°∞ ÏÉâÏÉÅ</label>
                                <div class="input-group">
                                    <span class="input-group-text p-1">
                                        <div class="color-preview" 
                                             style="width: 35px; height: 35px; background-color: <?= htmlspecialchars($all_settings['secondary_color'] ?? '#6c757d') ?>; border-radius: 4px; border: 2px solid #dee2e6; cursor: pointer;"
                                             data-color-target="secondary_color"></div>
                                    </span>
                                    <input type="color" class="form-control color-picker" 
                                           id="secondary_color" name="secondary_color" 
                                           value="<?= htmlspecialchars($all_settings['secondary_color'] ?? '#6c757d') ?>"
                                           style="width: 60px;">
                                    <input type="text" class="form-control color-text" 
                                           value="<?= htmlspecialchars($all_settings['secondary_color'] ?? '#6c757d') ?>"
                                           data-color-input="secondary_color"
                                           placeholder="#6c757d">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="success_color" class="form-label">ÏÑ±Í≥µ ÏÉâÏÉÅ</label>
                                <div class="input-group">
                                    <span class="input-group-text p-1">
                                        <div class="color-preview" 
                                             style="width: 35px; height: 35px; background-color: <?= htmlspecialchars($all_settings['success_color'] ?? '#198754') ?>; border-radius: 4px; border: 2px solid #dee2e6; cursor: pointer;"
                                             data-color-target="success_color"></div>
                                    </span>
                                    <input type="color" class="form-control color-picker" 
                                           id="success_color" name="success_color" 
                                           value="<?= htmlspecialchars($all_settings['success_color'] ?? '#198754') ?>"
                                           style="width: 60px;">
                                    <input type="text" class="form-control color-text" 
                                           value="<?= htmlspecialchars($all_settings['success_color'] ?? '#198754') ?>"
                                           data-color-input="success_color"
                                           placeholder="#198754">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="info_color" class="form-label">Ï†ïÎ≥¥ ÏÉâÏÉÅ</label>
                                <div class="input-group">
                                    <span class="input-group-text p-1">
                                        <div class="color-preview" 
                                             style="width: 35px; height: 35px; background-color: <?= htmlspecialchars($all_settings['info_color'] ?? '#0dcaf0') ?>; border-radius: 4px; border: 2px solid #dee2e6; cursor: pointer;"
                                             data-color-target="info_color"></div>
                                    </span>
                                    <input type="color" class="form-control color-picker" 
                                           id="info_color" name="info_color" 
                                           value="<?= htmlspecialchars($all_settings['info_color'] ?? '#0dcaf0') ?>"
                                           style="width: 60px;">
                                    <input type="text" class="form-control color-text" 
                                           value="<?= htmlspecialchars($all_settings['info_color'] ?? '#0dcaf0') ?>"
                                           data-color-input="info_color"
                                           placeholder="#0dcaf0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="warning_color" class="form-label">Í≤ΩÍ≥† ÏÉâÏÉÅ</label>
                                <div class="input-group">
                                    <span class="input-group-text p-1">
                                        <div class="color-preview" 
                                             style="width: 35px; height: 35px; background-color: <?= htmlspecialchars($all_settings['warning_color'] ?? '#ffc107') ?>; border-radius: 4px; border: 2px solid #dee2e6; cursor: pointer;"
                                             data-color-target="warning_color"></div>
                                    </span>
                                    <input type="color" class="form-control color-picker" 
                                           id="warning_color" name="warning_color" 
                                           value="<?= htmlspecialchars($all_settings['warning_color'] ?? '#ffc107') ?>"
                                           style="width: 60px;">
                                    <input type="text" class="form-control color-text" 
                                           value="<?= htmlspecialchars($all_settings['warning_color'] ?? '#ffc107') ?>"
                                           data-color-input="warning_color"
                                           placeholder="#ffc107">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="danger_color" class="form-label">ÏúÑÌóò ÏÉâÏÉÅ</label>
                                <div class="input-group">
                                    <span class="input-group-text p-1">
                                        <div class="color-preview" 
                                             style="width: 35px; height: 35px; background-color: <?= htmlspecialchars($all_settings['danger_color'] ?? '#dc3545') ?>; border-radius: 4px; border: 2px solid #dee2e6; cursor: pointer;"
                                             data-color-target="danger_color"></div>
                                    </span>
                                    <input type="color" class="form-control color-picker" 
                                           id="danger_color" name="danger_color" 
                                           value="<?= htmlspecialchars($all_settings['danger_color'] ?? '#dc3545') ?>"
                                           style="width: 60px;">
                                    <input type="text" class="form-control color-text" 
                                           value="<?= htmlspecialchars($all_settings['danger_color'] ?? '#dc3545') ?>"
                                           data-color-input="danger_color"
                                           placeholder="#dc3545">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="light_color" class="form-label">Î∞ùÏùÄ ÏÉâÏÉÅ</label>
                                <div class="input-group">
                                    <span class="input-group-text p-1">
                                        <div class="color-preview" 
                                             style="width: 35px; height: 35px; background-color: <?= htmlspecialchars($all_settings['light_color'] ?? '#f8f9fa') ?>; border-radius: 4px; border: 2px solid #dee2e6; cursor: pointer;"
                                             data-color-target="light_color"></div>
                                    </span>
                                    <input type="color" class="form-control color-picker" 
                                           id="light_color" name="light_color" 
                                           value="<?= htmlspecialchars($all_settings['light_color'] ?? '#f8f9fa') ?>"
                                           style="width: 60px;">
                                    <input type="text" class="form-control color-text" 
                                           value="<?= htmlspecialchars($all_settings['light_color'] ?? '#f8f9fa') ?>"
                                           data-color-input="light_color"
                                           placeholder="#f8f9fa">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="dark_color" class="form-label">Ïñ¥ÎëêÏö¥ ÏÉâÏÉÅ</label>
                                <div class="input-group">
                                    <span class="input-group-text p-1">
                                        <div class="color-preview" 
                                             style="width: 35px; height: 35px; background-color: <?= htmlspecialchars($all_settings['dark_color'] ?? '#212529') ?>; border-radius: 4px; border: 2px solid #dee2e6; cursor: pointer;"
                                             data-color-target="dark_color"></div>
                                    </span>
                                    <input type="color" class="form-control color-picker" 
                                           id="dark_color" name="dark_color" 
                                           value="<?= htmlspecialchars($all_settings['dark_color'] ?? '#212529') ?>"
                                           style="width: 60px;">
                                    <input type="text" class="form-control color-text" 
                                           value="<?= htmlspecialchars($all_settings['dark_color'] ?? '#212529') ?>"
                                           data-color-input="dark_color"
                                           placeholder="#212529">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end mt-3">
                        <button type="submit" name="save_theme" class="btn btn-primary">
                            <i class="bi bi-save"></i> Ï†ÄÏû•
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Ìè∞Ìä∏ ÏÑ§Ï†ï ÌÉ≠ -->
    <div class="tab-pane fade <?= $active_tab === 'font' ? 'show active' : '' ?>" id="font">
        <div class="card">
            <div class="card-body">
                <form action="site_settings.php?tab=font" method="POST">
                    <div class="mb-3">
                        <label for="body_font" class="form-label">Î≥∏Î¨∏ Ìè∞Ìä∏</label>
                        <select class="form-select" id="body_font" name="body_font">
                            <option value="'Segoe UI', sans-serif" <?= ($all_settings['body_font'] ?? '') === "'Segoe UI', sans-serif" ? 'selected' : '' ?>>Segoe UI (Í∏∞Î≥∏)</option>
                            <option value="'Malgun Gothic', sans-serif" <?= ($all_settings['body_font'] ?? '') === "'Malgun Gothic', sans-serif" ? 'selected' : '' ?>>ÎßëÏùÄ Í≥†Îîï</option>
                            <option value="'Nanum Gothic', sans-serif" <?= ($all_settings['body_font'] ?? '') === "'Nanum Gothic', sans-serif" ? 'selected' : '' ?>>ÎÇòÎàî Í≥†Îîï</option>
                            <option value="'Noto Sans KR', sans-serif" <?= ($all_settings['body_font'] ?? '') === "'Noto Sans KR', sans-serif" ? 'selected' : '' ?>>Noto Sans KR</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="heading_font" class="form-label">Ï†úÎ™© Ìè∞Ìä∏</label>
                        <select class="form-select" id="heading_font" name="heading_font">
                            <option value="'Segoe UI', sans-serif" <?= ($all_settings['heading_font'] ?? '') === "'Segoe UI', sans-serif" ? 'selected' : '' ?>>Segoe UI (Í∏∞Î≥∏)</option>
                            <option value="'Malgun Gothic', sans-serif" <?= ($all_settings['heading_font'] ?? '') === "'Malgun Gothic', sans-serif" ? 'selected' : '' ?>>ÎßëÏùÄ Í≥†Îîï</option>
                            <option value="'Nanum Gothic', sans-serif" <?= ($all_settings['heading_font'] ?? '') === "'Nanum Gothic', sans-serif" ? 'selected' : '' ?>>ÎÇòÎàî Í≥†Îîï</option>
                            <option value="'Noto Sans KR', sans-serif" <?= ($all_settings['heading_font'] ?? '') === "'Noto Sans KR', sans-serif" ? 'selected' : '' ?>>Noto Sans KR</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="font_size_base" class="form-label">Í∏∞Î≥∏ Ìè∞Ìä∏ ÌÅ¨Í∏∞</label>
                        <select class="form-select" id="font_size_base" name="font_size_base">
                            <option value="0.875rem" <?= ($all_settings['font_size_base'] ?? '') === '0.875rem' ? 'selected' : '' ?>>ÏûëÍ≤å (0.875rem)</option>
                            <option value="1rem" <?= ($all_settings['font_size_base'] ?? '') === '1rem' ? 'selected' : '' ?>>Î≥¥ÌÜµ (1rem)</option>
                            <option value="1.125rem" <?= ($all_settings['font_size_base'] ?? '') === '1.125rem' ? 'selected' : '' ?>>ÌÅ¨Í≤å (1.125rem)</option>
                            <option value="1.25rem" <?= ($all_settings['font_size_base'] ?? '') === '1.25rem' ? 'selected' : '' ?>>ÏïÑÏ£º ÌÅ¨Í≤å (1.25rem)</option>
                        </select>
                    </div>
                    
                    <div class="d-flex justify-content-end mt-3">
                        <button type="submit" name="save_font" class="btn btn-primary">
                            <i class="bi bi-save"></i> Ï†ÄÏû•
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Î†àÏù¥ÏïÑÏõÉ ÏÑ§Ï†ï ÌÉ≠ -->
    <div class="tab-pane fade <?= $active_tab === 'layout' ? 'show active' : '' ?>" id="layout">
        <div class="card">
            <div class="card-body">
                <form action="site_settings.php?tab=layout" method="POST">
                    <div class="mb-3">
                        <label for="navbar_layout" class="form-label">ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò Î∞î Î†àÏù¥ÏïÑÏõÉ</label>
                        <select class="form-select" id="navbar_layout" name="navbar_layout">
                            <option value="fixed-top" <?= ($all_settings['navbar_layout'] ?? '') === 'fixed-top' ? 'selected' : '' ?>>ÏÉÅÎã® Í≥†Ï†ï (Fixed Top)</option>
                            <option value="sticky-top" <?= ($all_settings['navbar_layout'] ?? '') === 'sticky-top' ? 'selected' : '' ?>>Ïä§ÌÅ¨Î°§ Ïãú Í≥†Ï†ï (Sticky Top)</option>
                            <option value="static-top" <?= ($all_settings['navbar_layout'] ?? '') === 'static-top' ? 'selected' : '' ?>>Ï†ïÏ†Å ÏÉÅÎã® (Static Top)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sidebar_layout" class="form-label">ÏÇ¨Ïù¥ÎìúÎ∞î ÏúÑÏπò</label>
                        <select class="form-select" id="sidebar_layout" name="sidebar_layout">
                            <option value="left" <?= ($all_settings['sidebar_layout'] ?? '') === 'left' ? 'selected' : '' ?>>ÏôºÏ™Ω</option>
                            <option value="right" <?= ($all_settings['sidebar_layout'] ?? '') === 'right' ? 'selected' : '' ?>>Ïò§Î•∏Ï™Ω</option>
                            <option value="none" <?= ($all_settings['sidebar_layout'] ?? '') === 'none' ? 'selected' : '' ?>>ÏóÜÏùå</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="footer_layout" class="form-label">Ìë∏ÌÑ∞ Î†àÏù¥ÏïÑÏõÉ</label>
                        <select class="form-select" id="footer_layout" name="footer_layout">
                            <option value="standard" <?= ($all_settings['footer_layout'] ?? '') === 'standard' ? 'selected' : '' ?>>Í∏∞Î≥∏</option>
                            <option value="expanded" <?= ($all_settings['footer_layout'] ?? '') === 'expanded' ? 'selected' : '' ?>>ÌôïÏû•</option>
                            <option value="minimal" <?= ($all_settings['footer_layout'] ?? '') === 'minimal' ? 'selected' : '' ?>>ÏµúÏÜå</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="container_width" class="form-label">Ïª®ÌÖåÏù¥ÎÑà ÎÑàÎπÑ</label>
                        <select class="form-select" id="container_width" name="container_width">
                            <option value="standard" <?= ($all_settings['container_width'] ?? '') === 'standard' ? 'selected' : '' ?>>Í∏∞Î≥∏ (ÏµúÎåÄ 1140px)</option>
                            <option value="fluid" <?= ($all_settings['container_width'] ?? '') === 'fluid' ? 'selected' : '' ?>>Ïú†ÎèôÏ†Å (100%)</option>
                            <option value="narrow" <?= ($all_settings['container_width'] ?? '') === 'narrow' ? 'selected' : '' ?>>Ï¢ÅÍ≤å (ÏµúÎåÄ 960px)</option>
                            <option value="wide" <?= ($all_settings['container_width'] ?? '') === 'wide' ? 'selected' : '' ?>>ÎÑìÍ≤å (ÏµúÎåÄ 1320px)</option>
                        </select>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="submit" name="save_layout" class="btn btn-primary">
                            <i class="bi bi-save"></i> Ï†ÄÏû•
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- SNS ÏÑ§Ï†ï ÌÉ≠ -->
    <div class="tab-pane fade <?= $active_tab === 'social' ? 'show active' : '' ?>" id="social">
        <div class="card">
            <div class="card-body">
                <form action="site_settings.php?tab=social" method="POST">
                    <div class="mb-3">
                        <label for="facebook_url" class="form-label">
                            <i class="bi bi-facebook text-primary"></i> Facebook
                        </label>
                        <input type="url" class="form-control" id="facebook_url" name="facebook_url" value="<?= htmlspecialchars($all_settings['facebook_url'] ?? '') ?>" placeholder="https://facebook.com/yourpage">
                    </div>
                    
                    <div class="mb-3">
                        <label for="twitter_url" class="form-label">
                            <i class="bi bi-twitter text-info"></i> Twitter / X
                        </label>
                        <input type="url" class="form-control" id="twitter_url" name="twitter_url" value="<?= htmlspecialchars($all_settings['twitter_url'] ?? '') ?>" placeholder="https://twitter.com/youraccount">
                    </div>
                    
                    <div class="mb-3">
                        <label for="instagram_url" class="form-label">
                            <i class="bi bi-instagram text-danger"></i> Instagram
                        </label>
                        <input type="url" class="form-control" id="instagram_url" name="instagram_url" value="<?= htmlspecialchars($all_settings['instagram_url'] ?? '') ?>" placeholder="https://instagram.com/youraccount">
                    </div>
                    
                    <div class="mb-3">
                        <label for="youtube_url" class="form-label">
                            <i class="bi bi-youtube text-danger"></i> YouTube
                        </label>
                        <input type="url" class="form-control" id="youtube_url" name="youtube_url" value="<?= htmlspecialchars($all_settings['youtube_url'] ?? '') ?>" placeholder="https://youtube.com/c/yourchannel">
                    </div>
                    
                    <div class="mb-3">
                        <label for="kakaotalk_url" class="form-label">
                            <i class="bi bi-chat-fill text-warning"></i> Ïπ¥Ïπ¥Ïò§ÌÜ° Ï±ÑÎÑê
                        </label>
                        <input type="url" class="form-control" id="kakaotalk_url" name="kakaotalk_url" value="<?= htmlspecialchars($all_settings['kakaotalk_url'] ?? '') ?>" placeholder="https://pf.kakao.com/_xxxxxx">
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="submit" name="save_social" class="btn btn-primary">
                            <i class="bi bi-save"></i> Ï†ÄÏû•
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Í∏∞ÌÉÄ ÏÑ§Ï†ï ÌÉ≠ -->
    <div class="tab-pane fade <?= $active_tab === 'other' ? 'show active' : '' ?>" id="other">
        <div class="card">
            <div class="card-body">
                <form action="site_settings.php?tab=other" method="POST">
                    <div class="mb-3">
                        <label for="google_analytics_id" class="form-label">Google Analytics ID</label>
                        <input type="text" class="form-control" id="google_analytics_id" name="google_analytics_id" value="<?= htmlspecialchars($all_settings['google_analytics_id'] ?? '') ?>" placeholder="G-XXXXXXXXXX ÎòêÎäî UA-XXXXXXXX-X">
                    </div>
                    
                    <div class="mb-3">
                        <label for="custom_css" class="form-label">ÏÇ¨Ïö©Ïûê Ï†ïÏùò CSS</label>
                        <textarea class="form-control" id="custom_css" name="custom_css" rows="8"><?= htmlspecialchars($all_settings['custom_css'] ?? '') ?></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="custom_js" class="form-label">ÏÇ¨Ïö©Ïûê Ï†ïÏùò JavaScript</label>
                        <textarea class="form-control" id="custom_js" name="custom_js" rows="8"><?= htmlspecialchars($all_settings['custom_js'] ?? '') ?></textarea>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="submit" name="save_other" class="btn btn-primary">
                            <i class="bi bi-save"></i> Ï†ÄÏû•
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ÌÖåÎßà ÎØ∏Î¶¨Î≥¥Í∏∞ Î™®Îã¨ -->
<div class="modal fade" id="themePreviewModal" tabindex="-1" aria-labelledby="themePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="themePreviewModalLabel">
                    <i class="bi bi-eye"></i> ÌÖåÎßà ÎØ∏Î¶¨Î≥¥Í∏∞
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="d-flex justify-content-center align-items-center" style="min-height: 400px;" id="previewLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Î°úÎî© Ï§ë...</span>
                    </div>
                </div>
                <iframe id="themePreviewFrame" src="" frameborder="0" style="width: 100%; height: 600px; display: none;"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
                <button type="button" class="btn btn-primary" onclick="openPreviewInNewTab()">
                    <i class="bi bi-box-arrow-up-right"></i> ÏÉà ÌÉ≠ÏóêÏÑú Î≥¥Í∏∞
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Î∞±ÏóÖ Í¥ÄÎ¶¨ Î™®Îã¨ -->
<div class="modal fade" id="backupModal" tabindex="-1" aria-labelledby="backupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="backupModalLabel">
                    <i class="bi bi-clock-history"></i> ÌÖåÎßà Î∞±ÏóÖ Í¥ÄÎ¶¨
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <button type="button" class="btn btn-success" onclick="createBackup()">
                            <i class="bi bi-plus-circle"></i> ÌòÑÏû¨ ÏÑ§Ï†ï Î∞±ÏóÖ
                        </button>
                    </div>
                    <div class="col-md-6 text-end">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="cleanOldBackupsUI()">
                            <i class="bi bi-trash"></i> Ïò§ÎûòÎêú Î∞±ÏóÖ Ï†ïÎ¶¨
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Î∞±ÏóÖ ÌååÏùºÎ™Ö</th>
                                <th>ÏÉùÏÑ±ÏùºÏãú</th>
                                <th>ÌÖåÎßà</th>
                                <th>ÌååÏùº ÌÅ¨Í∏∞</th>
                                <th>ÏûëÏóÖ</th>
                            </tr>
                        </thead>
                        <tbody id="backupListTable">
                            <tr>
                                <td colspan="5" class="text-center">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Î°úÎî© Ï§ë...</span>
                                    </div>
                                    Î∞±ÏóÖ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
            </div>
        </div>
    </div>
</div>

<style>
.nav-tabs .nav-link {
    border: none;
    border-bottom: 2px solid transparent;
}
.nav-tabs .nav-link.active {
    border: none;
    border-bottom: 2px solid #0d6efd;
    color: #0d6efd;
}
.nav-tabs .nav-link:hover {
    border-color: transparent;
    border-bottom: 2px solid rgba(13, 110, 253, 0.5);
}

/* ÌÖåÎßà ÌîÑÎ¶¨ÏÖã Ïä§ÌÉÄÏùº */
.theme-preview-card {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    border-width: 2px !important;
}

.theme-preview-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.theme-preview-card.border-primary {
    border-color: #0d6efd !important;
    box-shadow: 0 0 0 0.1rem rgba(13, 110, 253, 0.25);
}

.color-sample {
    width: 20px;
    height: 20px;
    border-radius: 3px;
    border: 1px solid #dee2e6;
    flex-shrink: 0;
}

.theme-color-preview {
    min-height: 45px;
}

/* ÌÅ¥Î¶≠ Í∞ÄÎä•Ìïú ÌÖåÎßà Ïπ¥Îìú Ïä§ÌÉÄÏùº */
.theme-preview-card {
    position: relative;
    user-select: none;
}

.theme-preview-card input[type="radio"] {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
    transform: scale(1.2);
}

.theme-preview-card:hover {
    cursor: pointer;
}

.theme-preview-card label {
    cursor: pointer;
    pointer-events: none;
}

/* ÏÉâÏÉÅ ÏÑ†ÌÉùÍ∏∞ Ïä§ÌÉÄÏùº Í∞úÏÑ† */
.color-picker {
    min-width: 50px !important;
    height: 38px !important;
    padding: 1px 2px !important;
    border: 1px solid #ced4da !important;
}

.color-text {
    font-family: monospace;
    font-size: 0.9em;
}

.color-preview {
    transition: all 0.2s ease;
}

.color-preview:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
</style>

<?php
$main_content = ob_get_clean();

$inline_js = "
// Ï†ÑÏó≠ Î≥ÄÏàò
let currentPreviewTheme = '';

// ÌÖåÎßà ÎØ∏Î¶¨Î≥¥Í∏∞ Ìï®ÏàòÎì§
function previewSelectedTheme() {
    const selectedTheme = document.querySelector('input[name=\"theme_preset\"]:checked');
    if (!selectedTheme) {
        alert('ÎØ∏Î¶¨Î≥¥Í∏∞Ìï† ÌÖåÎßàÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
        return;
    }
    
    const themeId = selectedTheme.value;
    currentPreviewTheme = themeId;
    
    const modal = new bootstrap.Modal(document.getElementById('themePreviewModal'));
    const previewFrame = document.getElementById('themePreviewFrame');
    const previewLoading = document.getElementById('previewLoading');
    
    // Î°úÎî© ÌëúÏãú
    previewFrame.style.display = 'none';
    previewLoading.style.display = 'flex';
    
    // ÎØ∏Î¶¨Î≥¥Í∏∞ URL ÏÑ§Ï†ï
    const previewUrl = 'theme_preview.php?theme_id=' + encodeURIComponent(themeId) + '&type=iframe';
    
    previewFrame.onload = function() {
        previewLoading.style.display = 'none';
        previewFrame.style.display = 'block';
    };
    
    previewFrame.src = previewUrl;
    modal.show();
}

function openPreviewInNewTab() {
    if (currentPreviewTheme) {
        const previewUrl = 'theme_preview.php?theme_id=' + encodeURIComponent(currentPreviewTheme) + '&type=full';
        window.open(previewUrl, '_blank');
    }
}

// Î∞±ÏóÖ Í¥ÄÎ¶¨ Ìï®ÏàòÎì§
function loadBackupList() {
    const tableBody = document.getElementById('backupListTable');
    
    fetch('theme_backup_api.php?action=list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayBackupList(data.backups);
            } else {
                tableBody.innerHTML = '<tr><td colspan=\"5\" class=\"text-center text-danger\">Î∞±ÏóÖ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§: ' + (data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò') + '</td></tr>';
            }
        })
        .catch(error => {
            console.error('Î∞±ÏóÖ Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
            tableBody.innerHTML = '<tr><td colspan=\"5\" class=\"text-center text-danger\">Î∞±ÏóÖ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</td></tr>';
        });
}

function displayBackupList(backups) {
    const tableBody = document.getElementById('backupListTable');
    
    if (!backups || backups.length === 0) {
        tableBody.innerHTML = '<tr><td colspan=\"5\" class=\"text-center text-muted\">Î∞±ÏóÖ ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§.</td></tr>';
        return;
    }
    
    let html = '';
    backups.forEach(backup => {
        html += '<tr>' +
            '<td><code>' + backup.filename + '</code></td>' +
            '<td>' + backup.created_at + '</td>' +
            '<td><span class=\"badge bg-info\">' + backup.theme_id + '</span></td>' +
            '<td>' + backup.formatted_size + '</td>' +
            '<td>' +
                '<button type=\"button\" class=\"btn btn-outline-primary btn-sm\" onclick=\"restoreBackup(\'' + backup.filename + '\')\">'+
                    '<i class=\"bi bi-arrow-clockwise\"></i> Î≥µÏõê' +
                '</button>' +
                '<button type=\"button\" class=\"btn btn-outline-danger btn-sm ms-1\" onclick=\"deleteBackup(\'' + backup.filename + '\')\">'+
                    '<i class=\"bi bi-trash\"></i>' +
                '</button>' +
            '</td>' +
        '</tr>';
    });
    
    tableBody.innerHTML = html;
}

function createBackup() {
    if (!confirm('ÌòÑÏû¨ ÌÖåÎßà ÏÑ§Ï†ïÏùÑ Î∞±ÏóÖÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        return;
    }
    
    const createButton = event.target;
    const originalText = createButton.innerHTML;
    createButton.innerHTML = '<span class=\"spinner-border spinner-border-sm\" role=\"status\"></span> Î∞±ÏóÖ Ï§ë...';
    createButton.disabled = true;
    
    fetch('theme_backup_api.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'create'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Î∞±ÏóÖÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§: ' + data.filename);
            loadBackupList(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        } else {
            alert('Î∞±ÏóÖ ÏÉùÏÑ± Ïã§Ìå®: ' + (data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
        }
    })
    .catch(error => {
        console.error('Î∞±ÏóÖ ÏÉùÏÑ± Ïò§Î•ò:', error);
        alert('Î∞±ÏóÖ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    })
    .finally(() => {
        createButton.innerHTML = originalText;
        createButton.disabled = false;
    });
}

function restoreBackup(filename) {
    if (!confirm('Î∞±ÏóÖÏùÑ Î≥µÏõêÌïòÏãúÍ≤†ÏäµÎãàÍπå? ÌòÑÏû¨ ÏÑ§Ï†ïÏù¥ Î≥ÄÍ≤ΩÎê©ÎãàÎã§.\\n\\nÎ∞±ÏóÖ ÌååÏùº: ' + filename)) {
        return;
    }
    
    fetch('theme_backup_api.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'restore',
            filename: filename
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Î∞±ÏóÖÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥µÏõêÎêòÏóàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§.');
            location.reload();
        } else {
            alert('Î∞±ÏóÖ Î≥µÏõê Ïã§Ìå®: ' + (data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
        }
    })
    .catch(error => {
        console.error('Î∞±ÏóÖ Î≥µÏõê Ïò§Î•ò:', error);
        alert('Î∞±ÏóÖ Î≥µÏõê Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    });
}

function deleteBackup(filename) {
    if (!confirm('Î∞±ÏóÖ ÌååÏùºÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.\\n\\nÌååÏùº: ' + filename)) {
        return;
    }
    
    fetch('theme_backup_api.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'delete',
            filename: filename
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Î∞±ÏóÖ ÌååÏùºÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            loadBackupList(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        } else {
            alert('Î∞±ÏóÖ ÌååÏùº ÏÇ≠Ï†ú Ïã§Ìå®: ' + (data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
        }
    })
    .catch(error => {
        console.error('Î∞±ÏóÖ ÏÇ≠Ï†ú Ïò§Î•ò:', error);
        alert('Î∞±ÏóÖ ÌååÏùº ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    });
}

function cleanOldBackupsUI() {
    if (!confirm('30Ïùº Ïù¥ÏÉÅ Îêú Î∞±ÏóÖ ÌååÏùºÎì§ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        return;
    }
    
    fetch('theme_backup_api.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'cleanup'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Ïò§ÎûòÎêú Î∞±ÏóÖ ÌååÏùº ' + data.deleted_count + 'Í∞úÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            loadBackupList(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        } else {
            alert('Î∞±ÏóÖ Ï†ïÎ¶¨ Ïã§Ìå®: ' + (data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
        }
    })
    .catch(error => {
        console.error('Î∞±ÏóÖ Ï†ïÎ¶¨ Ïò§Î•ò:', error);
        alert('Î∞±ÏóÖ Ï†ïÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    });
}

// Î∞±ÏóÖ Î™®Îã¨Ïù¥ Ïó¥Î¶¥ Îïå Î™©Î°ù Î°úÎìú
document.getElementById('backupModal').addEventListener('shown.bs.modal', function() {
    loadBackupList();
});

document.addEventListener('DOMContentLoaded', function() {
    console.log('ÌÖåÎßà ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî ÏãúÏûë');
    
    // ÌÉ≠ ÌôúÏÑ±Ìôî
    const hash = window.location.hash;
    if (hash) {
        const tab = document.querySelector('a[href=\"' + hash + '\"]');
        if (tab) {
            tab.click();
        }
    }
    
    // ÌÖåÎßà ÌîÑÎ¶¨ÏÖã Ïπ¥Îìú ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    const themeCards = document.querySelectorAll('.theme-preview-card');
    console.log('ÌÖåÎßà Ïπ¥Îìú Í∞úÏàò:', themeCards.length);
    
    themeCards.forEach(function(card) {
        card.addEventListener('click', function(e) {
            const radio = card.querySelector('input[type=\"radio\"]');
            console.log('Ïπ¥Îìú ÌÅ¥Î¶≠Îê®, ÎùºÎîîÏò§ Î≤ÑÌäº:', radio);
            
            if (radio && e.target !== radio) {
                // ÎùºÎîîÏò§ Î≤ÑÌäºÏùÑ ÏßÅÏ†ë ÌÅ¥Î¶≠Ìïú Í≤å ÏïÑÎãå Í≤ΩÏö∞Îßå Ï≤òÎ¶¨
                e.preventDefault();
                e.stopPropagation();
                
                // Î™®Îì† Ïπ¥ÎìúÏóêÏÑú ÏÑ†ÌÉù ÏÉÅÌÉú Ï†úÍ±∞
                themeCards.forEach(function(c) {
                    c.classList.remove('border-primary');
                    const r = c.querySelector('input[type=\"radio\"]');
                    if (r) r.checked = false;
                });
                
                // ÌòÑÏû¨ Ïπ¥Îìú ÏÑ†ÌÉù
                radio.checked = true;
                card.classList.add('border-primary');
                
                console.log('ÌÖåÎßà ÏÑ†ÌÉùÎê®:', radio.value);
            }
        });
        
        // ÎùºÎîîÏò§ Î≤ÑÌäº ÏßÅÏ†ë ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        const radio = card.querySelector('input[type=\"radio\"]');
        if (radio) {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    // Î™®Îì† Ïπ¥ÎìúÏóêÏÑú ÏÑ†ÌÉù ÏÉÅÌÉú Ï†úÍ±∞
                    themeCards.forEach(function(c) {
                        c.classList.remove('border-primary');
                    });
                    
                    // ÌòÑÏû¨ Ïπ¥Îìú ÏÑ†ÌÉù ÌëúÏãú
                    card.classList.add('border-primary');
                    console.log('ÎùºÎîîÏò§ Î≤ÑÌäºÏúºÎ°ú ÌÖåÎßà ÏÑ†ÌÉùÎê®:', this.value);
                }
            });
        }
    });
    
    // HTML5 ÏÉâÏÉÅ ÏÑ†ÌÉùÍ∏∞ Ïù¥Î≤§Ìä∏
    const colorPickers = document.querySelectorAll('.color-picker');
    const colorTexts = document.querySelectorAll('.color-text');
    const colorPreviews = document.querySelectorAll('.color-preview');
    
    console.log('ÏÉâÏÉÅ ÏÑ†ÌÉùÍ∏∞ ÏöîÏÜå Í∞úÏàò:', colorPickers.length);
    console.log('ÏÉâÏÉÅ ÌÖçÏä§Ìä∏ ÏöîÏÜå Í∞úÏàò:', colorTexts.length);
    console.log('ÏÉâÏÉÅ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏöîÏÜå Í∞úÏàò:', colorPreviews.length);
    
    // ÏÉâÏÉÅ ÏÑ†ÌÉùÍ∏∞ Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏
    colorPickers.forEach(function(picker) {
        picker.addEventListener('change', function() {
            const color = this.value;
            const id = this.id;
            
            console.log('ÏÉâÏÉÅ Î≥ÄÍ≤Ω:', id, color);
            
            // ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
            const preview = document.querySelector('[data-color-target=\"' + id + '\"]');
            if (preview) {
                preview.style.backgroundColor = color;
                console.log('ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏Îê®:', id, color);
            } else {
                console.log('ÎØ∏Î¶¨Î≥¥Í∏∞ ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå:', id);
            }
            
            // ÌÖçÏä§Ìä∏ ÏûÖÎ†• ÌïÑÎìú ÏóÖÎç∞Ïù¥Ìä∏
            const textInput = document.querySelector('[data-color-input=\"' + id + '\"]');
            if (textInput) {
                textInput.value = color;
                console.log('ÌÖçÏä§Ìä∏ ÏûÖÎ†• ÏóÖÎç∞Ïù¥Ìä∏Îê®:', id, color);
            } else {
                console.log('ÌÖçÏä§Ìä∏ ÏûÖÎ†• ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå:', id);
            }
        });
        
        picker.addEventListener('input', function() {
            // Ïã§ÏãúÍ∞Ñ ÎØ∏Î¶¨Î≥¥Í∏∞ (ÎìúÎûòÍ∑∏ Ï§ë)
            const color = this.value;
            const id = this.id;
            const preview = document.querySelector('[data-color-target=\"' + id + '\"]');
            if (preview) {
                preview.style.backgroundColor = color;
            }
        });
    });
    
    // ÌÖçÏä§Ìä∏ ÏûÖÎ†• ÌïÑÎìú Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏
    colorTexts.forEach(function(input) {
        input.addEventListener('input', function() {
            const color = this.value;
            const id = this.dataset.colorInput;
            
            // ÏÉâÏÉÅ ÌòïÏãù Í≤ÄÏ¶ù (Í∞ÑÎã®Ìïú hex Í≤ÄÏ¶ù)
            if (/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(color)) {
                // ÏÉâÏÉÅ ÏÑ†ÌÉùÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏
                const colorPicker = document.getElementById(id);
                if (colorPicker) {
                    colorPicker.value = color;
                }
                
                // ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
                const preview = document.querySelector('[data-color-target=\"' + id + '\"]');
                if (preview) {
                    preview.style.backgroundColor = color;
                }
            }
        });
    });
    
    // ÎØ∏Î¶¨Î≥¥Í∏∞ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏÉâÏÉÅ ÏÑ†ÌÉùÍ∏∞ Ïó¥Í∏∞)
    colorPreviews.forEach(function(preview) {
        preview.addEventListener('click', function() {
            const target = this.dataset.colorTarget;
            const colorPicker = document.getElementById(target);
            if (colorPicker) {
                colorPicker.click();
            }
        });
    });
    
    console.log('ÏÉâÏÉÅ ÏÑ†ÌÉùÍ∏∞ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
});
";

?>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title><?= htmlspecialchars($page_title) ?></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <?php foreach ($additional_css as $css): ?>
  <link rel="stylesheet" href="<?= htmlspecialchars($css) ?>">
  <?php endforeach; ?>
  <style>
    body { min-height: 100vh; display: flex; font-family: 'Segoe UI', sans-serif; }
    .sidebar { width: 220px; background-color: #343a40; color: white; min-height: 100vh; }
    .sidebar a { color: white; padding: 12px 16px; display: block; text-decoration: none; transition: background-color 0.2s; }
    .sidebar a:hover { background-color: #495057; }
    .sidebar a.active { background-color: #0d6efd; }
    .main-content { flex-grow: 1; padding: 30px; background-color: #f8f9fa; }
    .sidebar .logo { font-weight: bold; font-size: 1.3rem; padding: 16px; border-bottom: 1px solid #495057; }
    .table th { border-top: none; }
  </style>
</head>
<body>

<!-- ÏÇ¨Ïù¥ÎìúÎ∞î -->
<div class="sidebar">
  <div class="logo">
    <a href="/admin/index.php" class="text-white text-decoration-none">Ìù¨ÎßùÏî® Í¥ÄÎ¶¨Ïûê</a>
  </div>
  <a href="/admin/index.php">üìä ÎåÄÏãúÎ≥¥Îìú</a>
  <a href="/admin/posts/list.php">üìù Í≤åÏãúÍ∏Ä Í¥ÄÎ¶¨</a>
  <a href="/admin/boards/list.php">üìã Í≤åÏãúÌåê Í¥ÄÎ¶¨</a>
  <a href="/admin/menu/list.php">üß≠ Î©îÎâ¥ Í¥ÄÎ¶¨</a>
  <a href="/admin/inquiries/list.php">üì¨ Î¨∏Ïùò Í¥ÄÎ¶¨</a>
  <a href="/admin/events/list.php">üìÖ ÌñâÏÇ¨ Í¥ÄÎ¶¨</a>
  <a href="/admin/files/list.php">üìé ÏûêÎ£åÏã§ Í¥ÄÎ¶¨</a>
  <a href="/admin/settings/site_settings.php" class="active">üé® ÎîîÏûêÏù∏ ÏÑ§Ï†ï</a>
  <a href="/admin/system/performance.php">‚ö° ÏÑ±Îä• Î™®ÎãàÌÑ∞ÎßÅ</a>
  <a href="/admin/logout.php">üö™ Î°úÍ∑∏ÏïÑÏõÉ</a>
</div>

<!-- Î©îÏù∏ Ïª®ÌÖêÏ∏† -->
<div class="main-content">
  <?= $main_content ?>
</div>

<?php foreach ($additional_js as $js): ?>
<script src="<?= htmlspecialchars($js) ?>"></script>
<?php endforeach; ?>
<script>
<?= $inline_js ?>
</script>
</body>
</html>