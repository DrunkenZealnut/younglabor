<?php
include 'auth.php';

// Ïû¨ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Í¥ÄÎ¶¨Ïûê ÌîÑÎ†àÏûÑÏõåÌÅ¨ ÏÇ¨Ïö©
require_once 'templates_bridge.php';

// Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÑ§Ï†ï ÌÅ¥ÎûòÏä§ Î°úÎìú
require_once __DIR__ . '/../shared_admin_framework/config/DatabaseConfig.php';

if (session_status() === PHP_SESSION_NONE) session_start();

// DB Ïó∞Í≤∞
require_once 'db.php';

/**
 * ÏÑ§Ï†ï Í∏∞Î∞ò ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
 * ÌïòÎìúÏΩîÎî©Îêú ÌÖåÏù¥Î∏îÎ™Ö/Ïª¨ÎüºÎ™Ö ÎåÄÏã† ÏÑ§Ï†ïÏùÑ ÌÜµÌï¥ ÎèôÏ†ÅÏúºÎ°ú Ï≤òÎ¶¨
 */
function getStatisticsWithConfig($pdo) {
    $stats = [
        'total_boards' => 0,
        'total_posts' => 0,
        'total_inquiries' => 0,
        'total_visitors' => 0,
        'pending_inquiries' => 0,
        'recent_posts' => [],
        'recent_inquiries' => [],
        'upcoming_events' => []
    ];
    
    try {
        // ÏÑ§Ï†ïÏóêÏÑú ÎØ∏Î¶¨ Ï†ïÏùòÎêú ÏøºÎ¶¨Îì§ÏùÑ Í∞ÄÏ†∏ÏôÄÏÑú Ïã§Ìñâ
        $config = require __DIR__ . '/../config/admin_database.php';
        $dashboard_queries = $config['dashboard_queries'];
        
        foreach ($dashboard_queries as $key => $query_config) {
            try {
                $query = DatabaseConfig::parseQuery($query_config['query']);
                $stmt = $pdo->query($query);
                
                if (in_array($key, ['recent_posts', 'recent_inquiries', 'upcoming_events'])) {
                    // Î∞∞Ïó¥ Í≤∞Í≥º (Ïó¨Îü¨ Ìñâ)
                    $stats[$key] = $stmt->fetchAll(PDO::FETCH_ASSOC);
                } else {
                    // Îã®Ïùº Í∞í Í≤∞Í≥º
                    $stats[$key] = $stmt->fetchColumn();
                }
            } catch (PDOException $e) {
                // Í∞úÎ≥Ñ ÏøºÎ¶¨ Ïã§Ìå® Ïãú Î°úÍ∑∏Îßå Í∏∞Î°ùÌïòÍ≥† Í≥ÑÏÜç ÏßÑÌñâ
                error_log("ÌÜµÍ≥Ñ ÏøºÎ¶¨ Ïã§Ìå® [{$key}]: " . $e->getMessage());
                $stats[$key] = in_array($key, ['recent_posts', 'recent_inquiries', 'upcoming_events']) ? [] : 0;
            }
        }
        
    } catch (Exception $e) {
        error_log("ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ï†ÑÏ≤¥ Ïã§Ìå®: " . $e->getMessage());
    }
    
    return $stats;
}

/**
 * ÏÑ§Ï†ï Í∏∞Î∞òÏúºÎ°ú ÌÜµÍ≥Ñ Ïπ¥Îìú Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
 */
function generateStatsCards($statistics) {
    return [
        [
            'title' => 'Í≤åÏãúÌåê',
            'value' => number_format($statistics['total_boards']),
            'description' => 'ÌôúÏÑ±ÌôîÎêú Í≤åÏãúÌåê Ïàò',
            'icon' => 'bi-layout-text-window',
            'color' => 'primary',
            'url' => 'boards/list_templated.php'
        ],
        [
            'title' => 'Í≤åÏãúÍ∏Ä',
            'value' => number_format($statistics['total_posts']),
            'description' => 'Í≤åÏãúÎêú Í∏Ä Ïàò',
            'icon' => 'bi-file-earmark-text',
            'color' => 'success', 
            'url' => 'posts/list_templated.php'
        ],
        [
            'title' => 'Ï†ÑÏ≤¥ Î¨∏Ïùò',
            'value' => number_format($statistics['total_inquiries']),
            'description' => 'ÎàÑÏ†Å Î¨∏Ïùò Ïàò',
            'icon' => 'bi-envelope',
            'color' => 'warning',
            'url' => 'inquiries/list_templated.php'
        ],
        [
            'title' => 'Ïò§Îäò Î∞©Î¨∏Ïûê',
            'value' => number_format($statistics['total_visitors']),
            'description' => 'Í≥†Ïú† IP Í∏∞Ï§Ä',
            'icon' => 'bi-people',
            'color' => 'info',
            'url' => 'stats/visitors_templated.php'
        ]
    ];
}

// ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (ÏÑ§Ï†ï Í∏∞Î∞ò)
$statistics = getStatisticsWithConfig($pdo);
$stats_cards = generateStatsCards($statistics);

// HTML Ï∂úÎ†• ÏãúÏûë
ob_start();
?>

<h2>ÏïàÎÖïÌïòÏÑ∏Ïöî, <?= html_escape($_SESSION['admin_username']) ?>Îãò üëã</h2>
<p class="text-muted mb-4">Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄÏóê Ïò§Ïã† Í≤ÉÏùÑ ÌôòÏòÅÌï©ÎãàÎã§.</p>

<?php
// Ïû¨ÏÇ¨Ïö© ÌîÑÎ†àÏûÑÏõåÌÅ¨Î•º ÌÜµÌïú Ïª¥Ìè¨ÎÑåÌä∏ Î†åÎçîÎßÅ
echo admin_component('alerts');
echo admin_component('stats_cards', ['stats' => $stats_cards]);
?>

<!-- ÏµúÍ∑º ÌôúÎèô ÏÑπÏÖò -->
<div class="row mt-4">
    <!-- ÏµúÍ∑º Í≤åÏãúÍ∏Ä -->
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white border-0">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-text text-primary me-2"></i>
                        ÏµúÍ∑º Í≤åÏãúÍ∏Ä
                    </h5>
                    <a href="posts/list_templated.php" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-arrow-right me-1"></i>Ï†ÑÏ≤¥Î≥¥Í∏∞
                    </a>
                </div>
            </div>
            <div class="card-body">
                <?php if (empty($statistics['recent_posts'])): ?>
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 d-block mb-2 opacity-50"></i>
                        <p class="mb-0">Îì±Î°ùÎêú Í≤åÏãúÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§</p>
                    </div>
                <?php else: ?>
                    <div class="list-group list-group-flush">
                        <?php foreach ($statistics['recent_posts'] as $post): ?>
                            <div class="list-group-item px-0 py-3 border-0 border-bottom">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">
                                            <a href="posts/edit.php?id=<?= $post['id'] ?>" 
                                               class="text-decoration-none text-dark">
                                                <?= html_escape($post['title']) ?>
                                            </a>
                                        </h6>
                                        <small class="text-muted">
                                            <i class="bi bi-clock me-1"></i>
                                            <?= date('Y-m-d H:i', strtotime($post['created_at'])) ?>
                                        </small>
                                    </div>
                                    <span class="badge bg-light text-dark ms-2">#<?= $post['id'] ?></span>
                                </div>
                            </div>
                        <?php endforeach; ?>
                    </div>
                <?php endif; ?>
            </div>
        </div>
    </div>
    
    <!-- ÏµúÍ∑º Î¨∏Ïùò -->
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white border-0">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-envelope text-warning me-2"></i>
                        ÏµúÍ∑º Î¨∏Ïùò
                    </h5>
                    <a href="inquiries/list_templated.php" class="btn btn-sm btn-outline-warning">
                        <i class="bi bi-arrow-right me-1"></i>Ï†ÑÏ≤¥Î≥¥Í∏∞
                    </a>
                </div>
            </div>
            <div class="card-body">
                <?php if (empty($statistics['recent_inquiries'])): ?>
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 d-block mb-2 opacity-50"></i>
                        <p class="mb-0">Îì±Î°ùÎêú Î¨∏ÏùòÍ∞Ä ÏóÜÏäµÎãàÎã§</p>
                    </div>
                <?php else: ?>
                    <div class="list-group list-group-flush">
                        <?php foreach ($statistics['recent_inquiries'] as $inquiry): ?>
                            <div class="list-group-item px-0 py-3 border-0 border-bottom">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">
                                            <a href="inquiries/view.php?id=<?= $inquiry['id'] ?>" 
                                               class="text-decoration-none text-dark">
                                                <?= html_escape($inquiry['subject']) ?>
                                            </a>
                                        </h6>
                                        <small class="text-muted">
                                            <i class="bi bi-clock me-1"></i>
                                            <?= date('Y-m-d H:i', strtotime($inquiry['created_at'])) ?>
                                        </small>
                                    </div>
                                    <div class="ms-2">
                                        <?php if ($inquiry['status'] === 'pending'): ?>
                                            <span class="badge bg-warning text-dark">ÎåÄÍ∏∞Ï§ë</span>
                                        <?php elseif ($inquiry['status'] === 'answered'): ?>
                                            <span class="badge bg-success">ÎãµÎ≥ÄÏôÑÎ£å</span>
                                        <?php else: ?>
                                            <span class="badge bg-secondary"><?= html_escape($inquiry['status']) ?></span>
                                        <?php endif; ?>
                                    </div>
                                </div>
                            </div>
                        <?php endforeach; ?>
                    </div>
                <?php endif; ?>
            </div>
        </div>
    </div>
</div>

<!-- Îã§Í∞ÄÏò§Îäî ÌñâÏÇ¨ (ÏûàÎäî Í≤ΩÏö∞) -->
<?php if (!empty($statistics['upcoming_events'])): ?>
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white border-0">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-event text-info me-2"></i>
                        Îã§Í∞ÄÏò§Îäî ÌñâÏÇ¨
                    </h5>
                    <a href="events/list_templated.php" class="btn btn-sm btn-outline-info">
                        <i class="bi bi-arrow-right me-1"></i>Ï†ÑÏ≤¥Î≥¥Í∏∞
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <?php foreach ($statistics['upcoming_events'] as $event): ?>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="border rounded p-3">
                                <h6 class="mb-2">
                                    <a href="events/view.php?id=<?= $event['id'] ?>" 
                                       class="text-decoration-none">
                                        <?= html_escape($event['title']) ?>
                                    </a>
                                </h6>
                                <p class="text-muted mb-1">
                                    <i class="bi bi-calendar me-1"></i>
                                    <?= date('Y.m.d H:i', strtotime($event['start_date'])) ?>
                                </p>
                                <p class="text-muted mb-0">
                                    <i class="bi bi-geo-alt me-1"></i>
                                    <?= html_escape($event['location']) ?>
                                </p>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>
            </div>
        </div>
    </div>
</div>
<?php endif; ?>

<!-- Îπ†Î•∏ ÏûëÏóÖ -->
<?php
// ÌîÑÎ°úÏ†ùÌä∏Î≥Ñ Îπ†Î•∏ ÏûëÏóÖ Î≤ÑÌäº ÏÑ§Ï†ï
$quick_actions = [
    [
        'title' => 'ÏÉà Í≤åÏãúÍ∏Ä',
        'description' => 'Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ÎÇò Í≤åÏãúÍ∏ÄÏùÑ ÏûëÏÑ±Ìï©ÎãàÎã§',
        'icon' => 'bi-plus-circle',
        'url' => 'posts/write.php',
        'color' => 'primary'
    ],
    [
        'title' => 'Î¨∏Ïùò Í¥ÄÎ¶¨',
        'description' => 'ÎåÄÍ∏∞Ï§ëÏù∏ Î¨∏ÏùòÏÇ¨Ìï≠ÏùÑ ÌôïÏù∏Ìï©ÎãàÎã§',
        'icon' => 'bi-envelope-check',
        'url' => 'inquiries/list_templated.php?status=pending',
        'color' => 'warning',
        'badge' => $statistics['pending_inquiries'] > 0 ? $statistics['pending_inquiries'] : null
    ],
    [
        'title' => 'ÌñâÏÇ¨ Îì±Î°ù',
        'description' => 'ÏÉàÎ°úÏö¥ ÍµêÏú° ÌñâÏÇ¨Î•º Îì±Î°ùÌï©ÎãàÎã§',
        'icon' => 'bi-calendar-plus',
        'url' => 'events/create.php', 
        'color' => 'success'
    ],
    [
        'title' => 'ÏÇ¨Ïù¥Ìä∏ ÏÑ§Ï†ï',
        'description' => 'ÎîîÏûêÏù∏ Î∞è Í∏∞Î≥∏ ÏÑ§Ï†ïÏùÑ Î≥ÄÍ≤ΩÌï©ÎãàÎã§',
        'icon' => 'bi-gear',
        'url' => 'settings/site_settings.php',
        'color' => 'secondary'
    ]
];

echo admin_component('quick_actions', [
    'actions' => $quick_actions,
    'columns' => 4
]);
?>

<!-- ÏãúÏä§ÌÖú Í¥ÄÎ¶¨ ÎèÑÍµ¨ -->
<div class="mt-5">
    <h4 class="mb-3">
        <i class="bi bi-tools text-muted me-2"></i>
        ÏãúÏä§ÌÖú Í¥ÄÎ¶¨ ÎèÑÍµ¨
    </h4>
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card border-warning h-100">
                <div class="card-body">
                    <h5 class="card-title text-warning">
                        <i class="bi bi-database-gear me-2"></i>Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Í¥ÄÎ¶¨
                    </h5>
                    <p class="card-text">DB ÌÖåÏù¥Î∏î Ï¥àÍ∏∞Ìôî Î∞è Íµ¨Ï°∞ ÌôïÏù∏</p>
                    <div class="btn-group-vertical w-100" role="group">
                        <a href="check_table_structure.php" class="btn btn-outline-warning btn-sm">
                            <i class="bi bi-search me-1"></i>ÌÖåÏù¥Î∏î Íµ¨Ï°∞ ÌôïÏù∏
                        </a>
                        <a href="reset_visitor_log_table.php" class="btn btn-outline-warning btn-sm">
                            <i class="bi bi-arrow-clockwise me-1"></i>Î∞©Î¨∏Ïûê Î°úÍ∑∏ Ï¥àÍ∏∞Ìôî
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="card border-info h-100">
                <div class="card-body">
                    <h5 class="card-title text-info">
                        <i class="bi bi-speedometer2 me-2"></i>ÏÑ±Îä• Î™®ÎãàÌÑ∞ÎßÅ
                    </h5>
                    <p class="card-text">ÏãúÏä§ÌÖú ÏÑ±Îä• Î∞è ÌÜµÍ≥Ñ ÌôïÏù∏</p>
                    <div class="btn-group-vertical w-100" role="group">
                        <a href="stats/visitors_templated.php" class="btn btn-outline-info btn-sm">
                            <i class="bi bi-graph-up me-1"></i>Î∞©Î¨∏Ïûê ÌÜµÍ≥Ñ
                        </a>
                        <button class="btn btn-outline-info btn-sm" onclick="admin_clear_cache()">
                            <i class="bi bi-trash me-1"></i>Ï∫êÏãú ÌÅ¥Î¶¨Ïñ¥
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="card border-secondary h-100">
                <div class="card-body">
                    <h5 class="card-title text-secondary">
                        <i class="bi bi-shield-check me-2"></i>ÏÑ§Ï†ï & Î≥¥Ïïà
                    </h5>
                    <p class="card-text">ÏãúÏä§ÌÖú ÏÑ§Ï†ï Î∞è Î≥¥Ïïà Í¥ÄÎ¶¨</p>
                    <div class="btn-group-vertical w-100" role="group">
                        <a href="change_password.php" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-key me-1"></i>ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω
                        </a>
                        <a href="settings/site_settings.php" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-sliders me-1"></i>ÏÇ¨Ïù¥Ìä∏ ÏÑ§Ï†ï
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function admin_clear_cache() {
    if (confirm('Î™®Îì† Ï∫êÏãúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        // ÌîÑÎ†àÏûÑÏõåÌÅ¨Ïùò Ï∫êÏãú ÌÅ¥Î¶¨Ïñ¥ Í∏∞Îä• ÏÇ¨Ïö©
        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'action=clear_cache'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Ï∫êÏãúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                location.reload();
            } else {
                alert('Ï∫êÏãú ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Ï∫êÏãú ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        });
    }
}
</script>

<?php
$content = ob_get_clean();

// Î†àÏù¥ÏïÑÏõÉÏóê Ï†ÑÎã¨Ìï† Îç∞Ïù¥ÌÑ∞
$layout_data = [
    'page_title' => 'ÎåÄÏãúÎ≥¥Îìú',
    'active_menu' => 'dashboard',
    'site_name' => '<?= htmlspecialchars($admin_title) ?>',
    'content' => $content
];

// Ïû¨ÏÇ¨Ïö© ÌîÑÎ†àÏûÑÏõåÌÅ¨Î•º ÌÜµÌïú Î†àÏù¥ÏïÑÏõÉ Î†åÎçîÎßÅ
echo TemplateHelper::renderLayout('sidebar', $layout_data);
?>