<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>플러그인 로딩 디버그</title>
    <style>
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            margin: 20px; 
            background: #f8fafc; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
        }
        .status-ok { background: #dcfce7; color: #166534; }
        .status-error { background: #fee2e2; color: #dc2626; }
        .status-loading { background: #fef3c7; color: #d97706; }
        pre { 
            background: #f1f5f9; 
            padding: 15px; 
            border-radius: 4px; 
            overflow-x: auto; 
            font-size: 12px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 플러그인 로딩 상태 디버그</h1>
        
        <div id="loading-status">
            <h3>📦 파일 로딩 상태</h3>
            <div id="file-status"></div>
        </div>

        <div id="css-status">
            <h3>🎨 CSS 로딩 상태</h3>
            <div id="css-files"></div>
        </div>

        <div id="plugin-status">
            <h3>🔌 플러그인 등록 상태</h3>
            <div id="plugins-list"></div>
        </div>

        <div id="toolbar-test">
            <h3>🛠️ 툴바 테스트</h3>
            <div id="summernote"></div>
        </div>

        <div id="debug-info">
            <h3>🐛 디버그 정보</h3>
            <pre id="debug-log"></pre>
        </div>
    </div>

    <!-- jQuery와 Summernote -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/lang/summernote-ko-KR.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.css">
    
    <!-- 우리 CSS -->
    <link rel="stylesheet" href="css/editor-enhancements.css">

    <script>
        $(document).ready(function() {
            var debugLog = [];
            var fileStatus = $('#file-status');
            var cssFiles = $('#css-files');
            var pluginsList = $('#plugins-list');
            var debugInfo = $('#debug-log');

            function log(message) {
                console.log(message);
                debugLog.push(new Date().toLocaleTimeString() + ': ' + message);
                debugInfo.text(debugLog.join('\\n'));
            }

            function addStatus(container, file, status, error) {
                var statusClass = status === 'ok' ? 'status-ok' : status === 'error' ? 'status-error' : 'status-loading';
                var statusText = status === 'ok' ? '✅ 로드됨' : status === 'error' ? '❌ 실패' : '⏳ 로딩중';
                
                container.append(
                    $('<div class="status-item ' + statusClass + '">')
                        .append($('<span>').text(file))
                        .append($('<span>').text(statusText + (error ? ' - ' + error : '')))
                );
            }

            log('디버그 시작');

            // CSS 파일 확인
            var cssUrls = [
                'css/editor-enhancements.css'
            ];

            cssUrls.forEach(function(url) {
                var link = $('<link rel="stylesheet" href="' + url + '">');
                
                link.on('load', function() {
                    addStatus(cssFiles, url, 'ok');
                    log('CSS 로드 성공: ' + url);
                });
                
                link.on('error', function() {
                    addStatus(cssFiles, url, 'error', '파일을 찾을 수 없음');
                    log('CSS 로드 실패: ' + url);
                });
                
                $('head').append(link);
                addStatus(cssFiles, url, 'loading');
            });

            // JavaScript 파일 확인
            var jsFiles = [
                'js/summernote-plugins/core/plugin-loader.js',
                'js/summernote-plugins/core/plugin-base.js',
                'js/summernote-plugins/text-styles/strikethrough.js',
                'js/summernote-plugins/text-styles/superscript.js',
                'js/summernote-plugins/text-styles/subscript.js',
                'js/summernote-plugins/text-styles/highlighter.js',
                'js/summernote-plugins/paragraph/line-height.js',
                'js/summernote-plugins/paragraph/paragraph-styles.js',
                'js/summernote-plugins/content/checklist.js',
                'js/summernote-plugins/content/divider.js',
                'js/summernote-plugins/table/table-simple.js'
            ];

            var loadedCount = 0;
            var totalFiles = jsFiles.length;

            function loadNextScript(index) {
                if (index >= jsFiles.length) {
                    setTimeout(initializeSummernote, 500);
                    return;
                }

                var url = jsFiles[index];
                addStatus(fileStatus, url, 'loading');
                
                $.getScript(url)
                    .done(function() {
                        addStatus(fileStatus, url, 'ok');
                        log('JS 로드 성공: ' + url);
                        loadedCount++;
                    })
                    .fail(function() {
                        addStatus(fileStatus, url, 'error', '파일을 찾을 수 없거나 오류 발생');
                        log('JS 로드 실패: ' + url);
                    })
                    .always(function() {
                        loadNextScript(index + 1);
                    });
            }

            loadNextScript(0);

            function initializeSummernote() {
                log('Summernote 초기화 시작');
                
                // 플러그인 등록 상태 확인
                if ($.summernote && $.summernote.plugins) {
                    var plugins = $.summernote.plugins;
                    var pluginNames = [
                        'strikethrough', 'superscript', 'subscript', 'highlighter',
                        'lineHeight', 'paragraphStyles', 'checklist', 'divider', 'tableSimple'
                    ];

                    pluginNames.forEach(function(name) {
                        if (plugins[name]) {
                            addStatus(pluginsList, name, 'ok');
                            log('플러그인 등록됨: ' + name);
                        } else {
                            addStatus(pluginsList, name, 'error', '플러그인이 등록되지 않음');
                            log('플러그인 미등록: ' + name);
                        }
                    });
                } else {
                    log('$.summernote.plugins를 찾을 수 없음');
                }

                // Summernote 초기화
                try {
                    $('#summernote').summernote({
                        height: 200,
                        lang: 'ko-KR',
                        toolbar: [
                            ['style', ['style']],
                            ['font', ['bold', 'underline', 'italic', 'strikethrough', 'superscript', 'subscript', 'clear']],
                            ['color', ['color', 'highlighter']],
                            ['para', ['ul', 'ol', 'paragraph', 'lineHeight', 'paragraphStyles']],
                            ['content', ['checklist', 'divider']],
                            ['table', ['tableSimple']],
                            ['insert', ['link']],
                            ['view', ['codeview']]
                        ],
                        callbacks: {
                            onInit: function() {
                                log('Summernote 초기화 완료');
                                
                                // 툴바 버튼 확인
                                setTimeout(function() {
                                    var toolbar = $('.note-toolbar');
                                    var buttonTypes = [
                                        'strikethrough', 'superscript', 'subscript', 'highlighter',
                                        'line-height', 'paragraph-styles', 'checklist', 'divider', 'table-simple'
                                    ];

                                    buttonTypes.forEach(function(type) {
                                        var button = toolbar.find('.note-btn-' + type);
                                        if (button.length > 0) {
                                            log('툴바 버튼 발견: ' + type);
                                        } else {
                                            log('툴바 버튼 없음: ' + type);
                                        }
                                    });

                                    // 드롭다운 화살표 확인
                                    var dropdowns = toolbar.find('.dropdown-toggle');
                                    log('드롭다운 버튼 개수: ' + dropdowns.length);
                                    
                                    dropdowns.each(function(i, btn) {
                                        var $btn = $(btn);
                                        var hasCustomCaret = $btn.find('.note-icon-caret').length > 0;
                                        var computedAfter = window.getComputedStyle(btn, '::after');
                                        var hasAfterContent = computedAfter.content !== 'none' && computedAfter.content !== '""';
                                        
                                        log('드롭다운 ' + (i+1) + ': 커스텀화살표=' + hasCustomCaret + ', CSS화살표=' + hasAfterContent);
                                    });
                                }, 1000);
                            },
                            onError: function(e) {
                                log('Summernote 오류: ' + e);
                            }
                        }
                    });
                } catch (e) {
                    log('Summernote 초기화 실패: ' + e.message);
                }
            }

            log('디버그 도구 로드 완료');
        });
    </script>
</body>
</html>